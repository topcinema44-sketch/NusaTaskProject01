<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask - Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Premium Style -->
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(145deg, #0d1117, #161b22);
      color: #f0f6fc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .card {
      background: #161b22;
      padding: 2rem;
      border-radius: 1.5rem;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      text-align: center;
      width: 360px;
      animation: fadeIn 0.6s ease;
    }
    @keyframes fadeIn { from {opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
    h1 { margin: 0.5rem 0 1rem 0; }
    .logo {
      width: 70px; height: 70px;
      margin: auto;
      border-radius: 50%;
      background: #238636;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: bold;
      font-size: 1.3rem;
      color: white;
      margin-bottom: 1rem;
      box-shadow: 0 0 15px rgba(35,134,54,0.6);
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 8px 0;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      transition: 0.3s;
      font-size: 1rem;
      font-weight: 500;
    }
    button:hover { background: #2ea043; transform: translateY(-2px); }
    .progress {
      margin-top: 0.5rem;
      height: 8px;
      width: 100%;
      background: #30363d;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress div {
      height: 100%;
      width: 0%;
      background: #58a6ff;
      transition: width 0.5s ease;
    }
    .banned {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.95);
      color: red;
      font-size: 1.5rem;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 999;
    }
    .banned a { color: #58a6ff; }
    .input {
      margin: 0.3rem 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #30363d;
      width: 100%;
      background: #0d1117;
      color: #f0f6fc;
    }
    .loading {
      display: none;
      border: 4px solid #30363d;
      border-top: 4px solid #58a6ff;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
    }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
  </style>
</head>
<body>
  <!-- Login/Register -->
  <div class="card" id="authCard">
    <div class="logo">NT</div>
    <h1>Login</h1>
    <input class="input" id="email" type="email" placeholder="Email">
    <input class="input" id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
    <div class="loading" id="loading"></div>
    <p id="authMsg"></p>
  </div>

  <!-- Main App -->
  <div class="card" id="appCard" style="display:none">
    <div class="logo">NT</div>
    <h1>NusaTask</h1>
    <p>Saldo: <span id="saldo">0</span></p>

    <button onclick="doEarn()">ðŸŽ¯ Earn (+1)</button>
    <div class="progress"><div id="earnBar"></div></div>

    <button onclick="doBonus()">ðŸ’Ž Bonus (+30)</button>
    <div class="progress"><div id="bonusBar"></div></div>
    
    <p id="msg"></p>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Banned Overlay -->
  <div class="banned" id="banned" style="display:none">
    <p>ðŸš« Akun kamu dibanned!</p>
    <p>Hubungi admin: <a href="https://t.me/nusataskproject" target="_blank">@nusataskproject</a></p>
  </div>

<script>
  // ðŸ”¥ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAUcac_uXdofDbqPwltgb4m7qIPiQhJi0s",
    authDomain: "nusataskproject.firebaseapp.com",
    databaseURL: "https://nusataskproject-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nusataskproject",
    storageBucket: "nusataskproject.firebasestorage.app",
    messagingSenderId: "409602188456",
    appId: "1:409602188456:web:6302d3030b763324e28e9d",
    measurementId: "G-9389QL1WRE"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const COOLDOWN = 3 * 60 * 1000;
  const EARN_MAX = 25;
  const BONUS_MAX = 25;
  let userRef;

  // Helpers
  function getDeviceId() {
    let id = localStorage.getItem("deviceId");
    if (!id) {
      id = "dev-" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("deviceId", id);
    }
    return id;
  }
  async function getIP() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      return (await res.json()).ip;
    } catch { return "unknown"; }
  }
  function showLoading(show){ document.getElementById("loading").style.display = show?"block":"none"; }
  function showMsg(txt){ document.getElementById("msg").textContent=txt; setTimeout(()=>document.getElementById("msg").textContent="",2000);}
  function barProgress(id){ const bar=document.getElementById(id); bar.style.width="100%"; setTimeout(()=>bar.style.width="0%",600);}

  // Auth: Register & Login
  function register(){
    showLoading(true);
    auth.createUserWithEmailAndPassword(
      document.getElementById("email").value,
      document.getElementById("password").value
    ).then(()=>showLoading(false))
    .catch(e=>{showLoading(false);document.getElementById("authMsg").textContent=e.message;});
  }
  function login(){
    showLoading(true);
    auth.signInWithEmailAndPassword(
      document.getElementById("email").value,
      document.getElementById("password").value
    ).then(()=>showLoading(false))
    .catch(e=>{showLoading(false);document.getElementById("authMsg").textContent=e.message;});
  }

  // State
  auth.onAuthStateChanged(async user=>{
    if(user){
      document.getElementById("authCard").style.display="none";
      document.getElementById("appCard").style.display="block";
      const deviceId = getDeviceId();
      const ip = await getIP();
      userRef=db.ref("users/"+user.uid);

      userRef.once("value").then(async snap=>{
        if(!snap.exists()){
          const devRef = db.ref("devices/"+deviceId);
          const devSnap = await devRef.once("value");
          if(devSnap.exists() && devSnap.val().uid !== user.uid){ userRef.set({banned:true}); return; }
          else { devRef.set({uid:user.uid}); }

          const ipRef = db.ref("iplog/"+ip+"/"+user.uid);
          ipRef.set({ts:Date.now()});
          const ipSnap = await db.ref("iplog/"+ip).once("value");
          if(ipSnap.numChildren()>2){ userRef.set({banned:true}); return; }

          userRef.set({balance:0,earnUsedToday:0,bonusUsedToday:0,nextEarnAt:0,nextBonusAt:0,lastResetAt:Date.now(),banned:false,deviceId,ip});
        }
      });

      userRef.on("value",snap=>{
        const data=snap.val(); if(!data)return;
        if(data.banned){document.getElementById("banned").style.display="flex";}
        else{document.getElementById("saldo").textContent=data.balance||0;}
      });
    } else {
      document.getElementById("authCard").style.display="block";
      document.getElementById("appCard").style.display="none";
    }
  });

  // Reset
  function checkReset(data){
    let last=new Date(data.lastResetAt||0), now=new Date();
    if(last.toDateString()!==now.toDateString() && now.getHours()>=6){
      data.earnUsedToday=0; data.bonusUsedToday=0; data.lastResetAt=Date.now();
    }
    return data;
  }

  // Earn
  function doEarn(){
    if(!userRef)return;
    userRef.transaction(data=>{
      if(data){
        data=checkReset(data);
        if(data.earnUsedToday>=EARN_MAX){showMsg("Limit harian tercapai");return;}
        if(Date.now()<data.nextEarnAt){showMsg("Cooldown");return;}
        data.balance=(data.balance||0)+1;
        data.earnUsedToday=(data.earnUsedToday||0)+1;
        data.nextEarnAt=Date.now()+COOLDOWN;
      }
      return data;
    });
    barProgress("earnBar");
  }

  // Bonus
  function doBonus(){
    if(!userRef)return;
    userRef.transaction(data=>{
      if(data){
        data=checkReset(data);
        if(data.bonusUsedToday>=BONUS_MAX){showMsg("Limit harian tercapai");return;}
        if(Date.now()<data.nextBonusAt){showMsg("Cooldown");return;}
        data.balance=(data.balance||0)+30;
        data.bonusUsedToday=(data.bonusUsedToday||0)+1;
        data.nextBonusAt=Date.now()+COOLDOWN;
      }
      return data;
    });
    barProgress("bonusBar");
  }

  function logout(){auth.signOut();}
</script>
</body>
</html>