<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask - Earning</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1f1c2c, #928DAB);
      color: white;
      text-align: center;
      padding: 30px;
    }
    .card {
      background: rgba(0,0,0,0.6);
      padding: 20px;
      border-radius: 16px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      animation: fadeIn 1s ease;
    }
    input {
      margin: 5px;
      padding: 10px;
      width: 90%;
      border-radius: 8px;
      border: none;
    }
    button {
      margin: 10px;
      padding: 15px;
      width: 90%;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:disabled { background: grey; cursor: not-allowed; }
    .reward { background: #28a745; color: white; }
    .xstra { background: #007bff; color: white; }
    .authBtn { background: #ff9800; color: white; }
    #notif {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      display: none;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    #dashboard { display: none; }
  </style>
</head>
<body>
  <!-- üîë FORM LOGIN & REGISTER -->
  <div class="card" id="authBox">
    <h2>NusaTask - Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button class="authBtn" onclick="register()">Daftar</button>
    <button class="authBtn" onclick="login()">Login</button>
  </div>

  <!-- üèÜ DASHBOARD -->
  <div class="card" id="dashboard">
    <h2>NusaTask - Earning</h2>
    <p id="saldo">Saldo: Rp0</p>

    <h3>Ambil Reward</h3>
    <button id="reward1" class="reward">Ambil Reward 1</button>
    <button id="reward2" class="reward">Ambil Reward 2</button>

    <h3>Xstra Bonus</h3>
    <button id="xstra1" class="xstra">Xstra Bonus 1</button>
    <button id="xstra2" class="xstra">Xstra Bonus 2</button>

    <div id="notif"></div>
  </div>

<script>
  // üîë Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
    authDomain: "penyimpanansaldo-280df.firebaseapp.com",
    databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "penyimpanansaldo-280df",
    storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
    messagingSenderId: "659609775130",
    appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
    measurementId: "G-L4TW7E23H2"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  let userId;

  // üöÄ Register
  function register() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(email, pass)
      .then(user => {
        userId = user.user.uid;
        const deviceId = navigator.userAgent;
        fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(data => {
            db.ref("users/" + userId).set({
              email: email,
              saldo: 0,
              status: "active",
              createdAt: Date.now(),
              deviceId: deviceId,
              ip: data.ip
            });
          });
        showNotif("Registrasi sukses!", "green");
      })
      .catch(err => showNotif(err.message, "red"));
  }

  // üöÄ Login
  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, pass)
      .catch(err => showNotif(err.message, "red"));
  }

  // üîÑ Auto-login cek status
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      db.ref("users/" + userId).once("value", s => {
        const data = s.val();
        if (data.status === "banned") {
          showNotif("üö´ Akun dibanned. Hubungi @nusataskproject", "red");
          auth.signOut();
          return;
        }
        // üö® Anti tuyul: cek device & ip
        const nowDevice = navigator.userAgent;
        fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(ipData => {
            if (data.deviceId !== nowDevice || data.ip !== ipData.ip) {
              db.ref("users/" + userId + "/status").set("banned");
              showNotif("üö´ Akun terdeteksi curang, dibanned!", "red");
              auth.signOut();
              return;
            }
          });

        document.getElementById("authBox").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        loadSaldo();
      });
    } else {
      document.getElementById("authBox").style.display = "block";
      document.getElementById("dashboard").style.display = "none";
    }
  });

  // üîÑ Load saldo realtime
  function loadSaldo() {
    db.ref("users/" + userId + "/saldo").on("value", snap => {
      const saldo = snap.val() || 0;
      document.getElementById("saldo").innerText = "Saldo: Rp" + saldo.toLocaleString();
    });
  }

  // üö¶ Handle klik tombol reward/bonus
  function handleClick(btnId, type) {
    const btn = document.getElementById(btnId);
    const cooldownRef = db.ref("cooldowns/" + userId + "/" + btnId);
    const dailyRef = db.ref("daily/" + userId + "/" + btnId);

    cooldownRef.once("value", cSnap => {
      const now = Date.now();
      const cooldownEnd = cSnap.val() || 0;

      if (now < cooldownEnd) {
        const sisa = Math.ceil((cooldownEnd - now) / 1000);
        showNotif("‚è≥ Tunggu " + sisa + " detik lagi", "orange");
        return;
      }

      // ‚úÖ cek limit harian
      dailyRef.once("value", dSnap => {
        let data = dSnap.val() || { count: 0, lastReset: new Date().toDateString() };
        if (data.lastReset !== new Date().toDateString()) {
          data = { count: 0, lastReset: new Date().toDateString() };
        }
        if (data.count >= 20) {
          showNotif("‚ö†Ô∏è Limit harian tercapai untuk " + btnId, "red");
          return;
        }

        // üí∞ Tambah saldo
        const reward = (type === "reward") ? 200 : 500;
        const saldoRef = db.ref("users/" + userId + "/saldo");
        saldoRef.transaction(saldo => (saldo || 0) + reward);

        // ‚è±Ô∏è Simpan cooldown 2 menit
        cooldownRef.set(Date.now() + 2 * 60 * 1000);

        // üìä Update harian
        dailyRef.set({ count: data.count + 1, lastReset: data.lastReset });

        showNotif("‚úÖ Berhasil klaim Rp" + reward, "green");
        startCooldown(btn, 120);
      });
    });
  }

  // ‚è±Ô∏è Cooldown tombol
  function startCooldown(btn, durasi) {
    btn.disabled = true;
    let sisa = durasi;
    const asli = btn.innerText;
    const timer = setInterval(() => {
      btn.innerText = "‚è≥ " + sisa + "s";
      sisa--;
      if (sisa < 0) {
        clearInterval(timer);
        btn.disabled = false;
        btn.innerText = asli;
      }
    }, 1000);
  }

  // üîî Notifikasi
  function showNotif(msg, color) {
    const n = document.getElementById("notif");
    n.style.display = "block";
    n.style.background = color;
    n.innerText = msg;
    setTimeout(() => { n.style.display = "none"; }, 4000);
  }

  // üéØ Event tombol
  document.getElementById("reward1").onclick = () => handleClick("reward1","reward");
  document.getElementById("reward2").onclick = () => handleClick("reward2","reward");
  document.getElementById("xstra1").onclick = () => handleClick("xstra1","xstra");
  document.getElementById("xstra2").onclick = () => handleClick("xstra2","xstra");
</script>
</body>
</html>
