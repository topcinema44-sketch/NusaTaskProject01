<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NusaTask Project</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fade-in { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
    .animate-fade-in { animation:fade-in 1s ease-out forwards; }
    @keyframes progress { 0%{width:0%} 100%{width:100%} }
    .animate-progress { animation:progress 5s linear forwards; }
    @keyframes fade-toast { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
    .toast { animation:fade-toast 0.4s ease forwards; }
  </style>
</head>
<body class="bg-gray-900 text-white">

  <!-- Username -->
  <div id="user-info" class="fixed top-3 left-3 text-sm font-medium hidden"></div>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-black bg-opacity-90 z-50">
    <div class="text-3xl font-bold text-white opacity-0 animate-fade-in">NusaTask</div>
    <div class="w-12 h-12 mt-6 border-4 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
    <div class="w-48 h-2 bg-gray-700 mt-6 rounded-full overflow-hidden">
      <div id="progress-bar" class="h-full bg-purple-500 animate-progress"></div>
    </div>
    <p id="loading-text" class="mt-4 text-white text-lg">Memuat...</p>
  </div>

  <!-- Blokir Screen -->
  <div id="banned-screen" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-90 z-50">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl text-center max-w-md">
      <h1 class="text-2xl font-bold mb-4">⚠️ Akun Diblokir</h1>
      <p class="mb-4">Akun anda terdeteksi melakukan aktivitas mencurigakan / tuyul.</p>
      <p class="mb-6">Hubungi admin: <span class="text-purple-400 font-bold">@nusataskproject</span></p>
    </div>
  </div>

  <!-- Auth -->
  <div id="auth-section" class="h-screen flex items-center justify-center">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-80 text-center">
      <h1 class="text-xl font-bold mb-6">NusaTask</h1>
      <input id="email" type="email" placeholder="Email" class="w-full mb-3 px-3 py-2 rounded-lg text-black">
      <input id="password" type="password" placeholder="Password" class="w-full mb-4 px-3 py-2 rounded-lg text-black">
      <button onclick="loginOrRegister()" class="w-full py-2 bg-purple-600 rounded-xl font-bold hover:bg-purple-700 transition">Masuk / Daftar</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden p-6">
    <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6">
      Saldo: <span id="saldo" class="font-bold text-green-400">0</span> poin
    </div>
    <div class="flex flex-col gap-4">
      <button onclick="earn('monetag')" class="py-3 bg-blue-600 rounded-xl font-bold hover:bg-blue-700 transition">Menghasilkan</button>
      <button onclick="earn('klikadila')" class="py-3 bg-pink-600 rounded-xl font-bold hover:bg-pink-700 transition">Xstra Bonus</button>
    </div>
  </div>

  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyAUcac_uXdofDbqPwltgb4m7qIPiQhJi0s",
      authDomain: "nusataskproject.firebaseapp.com",
      databaseURL: "https://nusataskproject-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nusataskproject",
      storageBucket: "nusataskproject.firebasestorage.app",
      messagingSenderId: "409602188456",
      appId: "1:409602188456:web:6302d3030b763324e28e9d",
      measurementId: "G-9389QL1WRE"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.database();

    // === Helpers ===
    function deviceId(){
      let id=localStorage.getItem("deviceId");
      if(!id){ id="dev-"+Math.random().toString(36).substr(2,9); localStorage.setItem("deviceId",id); }
      return id;
    }
    function showLoading(text="Memuat..."){
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("loading-text").innerText=text;
      const bar=document.getElementById("progress-bar");
      bar.classList.remove("animate-progress"); void bar.offsetWidth; bar.classList.add("animate-progress");
      setTimeout(()=>hideLoading(),4000);
    }
    function hideLoading(){ document.getElementById("loading").classList.add("hidden"); }
    function showBanScreen(){ 
      document.getElementById("banned-screen").classList.remove("hidden"); 
      document.getElementById("auth-section").classList.add("hidden"); 
      document.getElementById("dashboard").classList.add("hidden"); 
    }
    function showNotif(msg,type="info"){
      const notif=document.createElement("div");
      notif.className=`toast fixed bottom-5 right-5 px-4 py-2 rounded-xl shadow-lg text-white
        ${type==="success"?"bg-green-500":type==="error"?"bg-red-500":"bg-blue-500"}`;
      notif.innerText=msg;document.body.appendChild(notif);
      setTimeout(()=>notif.remove(),4000);
    }

    // === Login/Register ===
    function loginOrRegister(){
      showLoading("Memproses...");
      const email=document.getElementById("email").value;
      const pass=document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email,pass)
      .then(()=>hideLoading())
      .catch(err=>{
        if(err.code==="auth/user-not-found"){
          auth.createUserWithEmailAndPassword(email,pass).then(()=>{
            hideLoading(); 
            db.ref("users/"+auth.currentUser.uid).set({saldo:0,device:deviceId(),banned:false});
            showNotif("Registrasi berhasil","success");
          }).catch(e=>{hideLoading(); showNotif(e.message,"error")});
        } else { hideLoading(); showNotif(err.message,"error"); }
      });
    }

    // === Auth State ===
    auth.onAuthStateChanged(user=>{
      if(user){
        const uid=user.uid;
        const ref=db.ref("users/"+uid);
        ref.once("value").then(snap=>{
          const data=snap.val()||{};
          if(data.banned){ showBanScreen(); auth.signOut(); return; }
          if(data.device && data.device!==deviceId()){ ref.update({banned:true}); showBanScreen(); auth.signOut(); return; }
          ref.update({device:deviceId()});
          document.getElementById("auth-section").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");
          const username=(user.email||"").split("@")[0];
          document.getElementById("user-info").innerText=username;
          document.getElementById("user-info").classList.remove("hidden");
          loadSaldo(uid);
          checkVPN(uid);
        });
      }
    });

    // === Saldo ===
    function loadSaldo(uid){ db.ref("users/"+uid+"/saldo").on("value",s=>{document.getElementById("saldo").innerText=s.val()||0;}); }

    // === Earn ===
    function earn(src){
      const u=auth.currentUser;if(!u)return;
      const uid=u.uid;
      const ref=db.ref("users/"+uid);
      ref.once("value").then(s=>{
        let d=s.val()||{saldo:0,lastClick:0,count:0,date:""};
        let today=new Date().toDateString();
        if(d.date!==today){d.count=0; d.date=today;}
        if(d.count>=20){showNotif("Limit harian tercapai","error"); return;}
        if(Date.now()-d.lastClick<180000){showNotif("Cooldown 3 menit","error"); return;}
        d.saldo+=30000; d.lastClick=Date.now(); d.count++;
        ref.set(d);
        showNotif("Berhasil +30.000 poin ("+src+")","success");
      });
    }

    // === VPN/Proxy Check ===
    async function checkVPN(uid){
      try{
        const res=await fetch("http://ip-api.com/json/");
        const d=await res.json();
        if(d.proxy||d.hosting){ db.ref("users/"+uid).update({banned:true}); showBanScreen(); auth.signOut(); }
      }catch(e){console.warn("VPN check fail",e);}
    }

    window.onload=()=>showLoading("Memuat...");
  </script>
</body>
</html>