<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NusaTask â€” Final (RTDB + Firestore)</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- Firebase (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
/* compact premium styling (same look from previous versions) */
:root{--grad1:#8b5cf6;--grad2:#06b6d4;--grad3:#10b981;--gold:#FFD700;--muted:#9aa7b6}
body{margin:0;font-family:Poppins,system-ui;background:linear-gradient(180deg,#07070b,#0f1724);color:#e6eef6;display:flex;justify-content:center;min-height:100vh}
.container{width:100%;max-width:420px;padding:20px}
.header{display:flex;flex-direction:column;align-items:center;margin-top:36px;gap:6px}
.brand{font-family:Orbitron;font-size:28px;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tag{color:var(--muted);font-size:13px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);border-radius:14px;padding:18px;margin-top:18px;backdrop-filter:blur(8px);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.top{display:flex;justify-content:space-between;align-items:center}
.saldo{color:var(--gold);font-weight:800;text-shadow:0 6px 18px rgba(255,215,0,0.06)}
.btn{width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#fff;font-weight:700;cursor:pointer;margin-top:12px;transition:transform .12s}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.progress-wrap{height:12px;background:rgba(255,255,255,0.04);border-radius:12px;overflow:hidden;margin-top:10px}
.progress{height:100%;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));background-size:200% 100%;animation:move 2s linear infinite}
@keyframes move{0%{background-position:0 0}100%{background-position:200% 0}}
.muted{color:var(--muted);font-size:13px;margin-top:8px;text-align:center}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
.box{width:min(420px,92%);background:linear-gradient(180deg,#061223,#0b1722);padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.6)}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;margin-top:10px}
.toast{position:fixed;left:50%;top:28px;transform:translateX(-50%);min-width:220px;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#fff;display:none;z-index:10000;text-align:center;font-weight:700}
.warnbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.85));z-index:9998}
.warn{background:#071224;padding:18px;border-radius:12px;color:#e6eef6;max-width:420px;text-align:center}
#banned{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.96);z-index:10001;color:#ff7b7b;text-align:center;padding:20px}
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="brand">NusaTask</div>
    <div class="tag">Premium â€¢ Realtime + Firestore</div>
  </div>

  <div class="card">
    <div class="top">
      <div>
        <div style="font-weight:800">Dashboard</div>
        <div class="small">Tekan tombol untuk menghasilkan. Cooldown 3 menit.</div>
      </div>
      <div class="saldo">Saldo: <span id="saldo">0</span></div>
    </div>

    <div style="margin-top:18px">
      <button id="earnBtn" class="btn">ðŸŽ¯ Earn (+1)</button>
      <div class="progress-wrap"><div id="earnBar" class="progress"></div></div>
      <div class="small" style="margin-top:8px">Terpakai hari ini: <span id="earnUsed">0</span>/<span id="earnMax">25</span></div>

      <button id="bonusBtn" class="btn">ðŸ’Ž Xstra Bonus (+30)</button>
      <div class="progress-wrap"><div id="bonusBar" class="progress"></div></div>
      <div class="small" style="margin-top:8px">Terpakai hari ini: <span id="bonusUsed">0</span>/<span id="bonusMax">25</span></div>
    </div>

    <div style="height:12px"></div>
    <div class="small">Jika dibanned hubungi admin: <a href="https://t.me/nusataskproject" style="color:#06b6d4">t.me/nusataskproject</a></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="font-family:Orbitron">Masuk / Daftar</h3>
    <input id="email" class="input" type="email" placeholder="Email">
    <input id="password" class="input" type="password" placeholder="Password (min 6)">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="loginBtn" class="btn" style="flex:1">Login</button>
      <button id="registerBtn" class="btn ghost" style="flex:1">Register</button>
    </div>
    <div class="small" style="margin-top:10px">Dengan mendaftar, segala bentuk hack/nuyul akan dibanned otomatis.</div>
  </div>
</div>

<!-- Warning after register -->
<div id="warning" class="warnbox"><div class="warn">
  <div style="font-weight:800;font-size:18px">Peringatan Penting</div>
  <div class="small" style="margin-top:8px">Segala bentuk hack / multi-akun dari 1 device atau 1 IP akan menyebabkan banned otomatis.</div>
  <div style="margin-top:12px"><button id="continueBtn" class="btn disabled">LANJUTKAN (5s)</button></div>
</div></div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Banned overlay -->
<div id="banned"><div style="font-weight:800;font-size:20px">ðŸš« AKUN DIBANNED</div><div class="small" style="margin-top:8px">Hubungi admin: <a href="https://t.me/nusataskproject" style="color:#06b6d4">t.me/nusataskproject</a></div></div>

<script>
/* ================== CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyAUcac_uXdofDbqPwltgb4m7qIPiQhJi0s",
  authDomain: "nusataskproject.firebaseapp.com",
  databaseURL: "https://nusataskproject-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nusataskproject",
  storageBucket: "nusataskproject.firebasestorage.app",
  messagingSenderId: "409602188456",
  appId: "1:409602188456:web:6302d3030b763324e28e9d",
  measurementId: "G-9389QL1WRE"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const rdb = firebase.database();
const fs = firebase.firestore();

/* ============== CONSTANTS & UI ============== */
const COOLDOWN = 3 * 60 * 1000; // 3 minutes
const EARN_MAX = 25;
const BONUS_MAX = 25;

const authModal = document.getElementById('authModal');
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const toastEl = document.getElementById('toast');
const warningBox = document.getElementById('warning');
const continueBtn = document.getElementById('continueBtn');
const bannedEl = document.getElementById('banned');

const saldoEl = document.getElementById('saldo');
const earnBtn = document.getElementById('earnBtn');
const bonusBtn = document.getElementById('bonusBtn');
const earnBar = document.getElementById('earnBar');
const bonusBar = document.getElementById('bonusBar');
const earnUsedEl = document.getElementById('earnUsed');
const bonusUsedEl = document.getElementById('bonusUsed');
document.getElementById('earnMax').innerText = EARN_MAX;
document.getElementById('bonusMax').innerText = BONUS_MAX;

/* ============== Helpers ============== */
function showToast(txt, t=2500){ toastEl.innerText = txt; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', t); }
function getDeviceId(){ let d = localStorage.getItem('nusatask_device'); if(!d){ d='dev-'+Math.random().toString(36).slice(2,12); localStorage.setItem('nusatask_device', d); } return d; }
const deviceId = getDeviceId();
async function fetchIP(){ try{ const r=await fetch('https://api.ipify.org?format=json'); const j=await r.json(); return j.ip||'unknown'; }catch(e){ return 'unknown'; } }

/* server time offset cache */
let _offset = null;
async function getServerTime(){
  if(_offset===null){ const snap = await rdb.ref('.info/serverTimeOffset').once('value'); _offset = snap.val() || 0; }
  return Date.now() + _offset;
}

/* ============== Auth UI actions ============== */
function openAuth(){ authModal.style.display='flex'; emailEl.focus(); }
function closeAuth(){ authModal.style.display='none'; }
loginBtn.addEventListener('click', async ()=>{
  const em = emailEl.value.trim(), pw = passEl.value;
  if(!em || pw.length<6){ showToast('Email & password (min 6)'); return; }
  showToast('Logging inâ€¦');
  try{ await auth.signInWithEmailAndPassword(em,pw); closeAuth(); } catch(e){ showToast('Login error: '+e.message,4000); }
});
registerBtn.addEventListener('click', async ()=>{
  const em = emailEl.value.trim(), pw = passEl.value;
  if(!em || pw.length<6){ showToast('Email & password (min 6)'); return; }
  showToast('Registeringâ€¦');
  try{
    await auth.createUserWithEmailAndPassword(em,pw);
    // flag show warning
    localStorage.setItem('nusatask_justRegistered','1');
    closeAuth();
  }catch(e){ showToast('Register error: '+e.message,4000); }
});

/* ============== Security checks & init ============== */
async function performSecurityChecks(uid){
  const ip = await fetchIP();
  const userRef = rdb.ref('users/'+uid);

  // 1) device binding check
  const devSnap = await rdb.ref('devices/'+deviceId).once('value');
  if(devSnap.exists() && devSnap.val().uid !== uid){
    await userRef.set({banned:true});
    return {ok:false, reason:'device_conflict'};
  }

  // 2) ip check
  const ipRoot = rdb.ref('iplog/'+ip);
  const ipSnap = await ipRoot.once('value');
  if(ipSnap.exists()){
    const keys = Object.keys(ipSnap.val()||{});
    for(const otherUid of keys){
      if(otherUid === uid) continue;
      // strictly ban multi-account from same IP unless it's the same device (we enforce 1 device=1 account)
      const otherDeviceSnap = await rdb.ref('users/'+otherUid+'/deviceId').once('value');
      const otherDevice = otherDeviceSnap.exists()?otherDeviceSnap.val():null;
      if(otherDevice === deviceId){
        // same device, different UID -> violates one-email-per-device -> ban
        await userRef.set({banned:true});
        return {ok:false, reason:'multi_email_same_device'};
      } else {
        // different device but same IP -> ban
        await userRef.set({banned:true});
        return {ok:false, reason:'ip_conflict'};
      }
    }
  }

  // 3) bind device & log ip
  await rdb.ref('devices/'+deviceId).set({uid:uid, createdAt: Date.now()});
  await ipRoot.child(uid).set({ts: Date.now()});
  return {ok:true, ip};
}

/* ============== Auth state handler ============== */
let currentUserRef = null;
auth.onAuthStateChanged(async user=>{
  if(!user){ openAuth(); return; }
  closeAuth();
  const uid = user.uid;
  const userRef = rdb.ref('users/'+uid);

  const sec = await performSecurityChecks(uid);
  if(!sec.ok){ // banned
    showBanned(); return;
  }

  // create default user doc if not exist
  const snap = await userRef.once('value');
  const serverNow = await getServerTime();
  if(!snap.exists()){
    await userRef.set({
      email: user.email || null,
      balance: 0,
      banned: false,
      deviceId,
      ip: sec.ip || 'unknown',
      earnUsedToday: 0,
      bonusUsedToday: 0,
      nextEarnAt: 0,
      nextBonusAt: 0,
      lastResetAt: serverNow,
      createdAt: serverNow
    });
  } else {
    // ensure device mapping exists
    await rdb.ref('devices/'+deviceId).set({uid, createdAt: snap.val().createdAt || serverNow});
    // update ip if changed
    const data = snap.val();
    if(data.ip !== sec.ip) { await userRef.update({ip: sec.ip}); await rdb.ref('iplog/'+sec.ip+'/'+uid).set({ts:Date.now()}); }
  }

  // if just registered show warning then continue
  if(localStorage.getItem('nusatask_justRegistered')==='1'){
    localStorage.removeItem('nusatask_justRegistered');
    await showWarningFlow();
  }

  // start realtime listener
  startUserListener(uid);
});

/* ============== Warning flow ============== */
async function showWarningFlow(){
  warningBox.style.display='flex';
  continueBtn.disabled = true; continueBtn.classList.add('disabled');
  let t = 5;
  while(t>0){ continueBtn.innerText = `LANJUTKAN (${t}s)`; await new Promise(r=>setTimeout(r,1000)); t--; }
  continueBtn.innerText = 'LANJUTKAN'; continueBtn.disabled=false; continueBtn.classList.remove('disabled');
  await new Promise(resolve => { continueBtn.onclick = ()=>{ warningBox.style.display='none'; continueBtn.onclick=null; resolve(); }; });
}

/* ============== Real-time user listener ============== */
async function startUserListener(uid){
  if(currentUserRef) currentUserRef.off();
  currentUserRef = rdb.ref('users/'+uid);
  currentUserRef.on('value', async snap=>{
    const data = snap.val(); if(!data) return;
    if(data.banned){ showBanned(); return; }

    // daily reset (server boundary 06:00)
    const serverNow = await getServerTime();
    const resetBoundary = (()=>{ const d=new Date(serverNow); d.setHours(6,0,0,0); if(serverNow < d.getTime()) d.setDate(d.getDate()-1); return d.getTime(); })();
    if(!data.lastResetAt || data.lastResetAt < resetBoundary){
      await currentUserRef.update({earnUsedToday:0, bonusUsedToday:0, lastResetAt: serverNow});
      data.earnUsedToday = 0; data.bonusUsedToday = 0;
    }

    // update UI
    saldoEl.innerText = (data.balance||0);
    earnUsedEl.innerText = data.earnUsedToday||0;
    bonusUsedEl.innerText = data.bonusUsedToday||0;
    earnBar.style.width = ((data.earnUsedToday||0)/EARN_MAX*100)+'%';
    bonusBar.style.width = ((data.bonusUsedToday||0)/BONUS_MAX*100)+'%';

    // cooldown control
    const serverNow2 = await getServerTime();
    if(serverNow2 < (data.nextEarnAt||0)) { earnBtn.classList.add('disabled'); } else { earnBtn.classList.remove('disabled'); }
    if(serverNow2 < (data.nextBonusAt||0)) { bonusBtn.classList.add('disabled'); } else { bonusBtn.classList.remove('disabled'); }
  });
}

/* ============== Earn & Bonus actions (RTDB transaction) ============== */
async function writeHistoryToFirestore(doc){
  try{ await fs.collection('transactions').add(doc); }
  catch(e){ console.warn('Firestore write failed', e); }
}

earnBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user) { showToast('Silakan login'); openAuth(); return; }
  if(earnBtn.classList.contains('disabled')) { showToast('Masih cooldown'); return; }
  const ref = rdb.ref('users/'+user.uid);
  const serverNow = await getServerTime();

  ref.transaction(data=>{
    if(!data) return;
    // in-transaction reset double-check
    const resetBoundary = (()=>{ const d=new Date(serverNow); d.setHours(6,0,0,0); if(serverNow < d.getTime()) d.setDate(d.getDate()-1); return d.getTime(); })();
    if(!data.lastResetAt || data.lastResetAt < resetBoundary){ data.earnUsedToday=0; data.bonusUsedToday=0; data.lastResetAt=serverNow; }

    if((data.earnUsedToday||0) >= EARN_MAX) { return; } // no change
    if(serverNow < (data.nextEarnAt||0)) { return; } // cooldown

    data.balance = (data.balance||0) + 1;
    data.earnUsedToday = (data.earnUsedToday||0) + 1;
    data.nextEarnAt = serverNow + COOLDOWN;
    data.lastActionAt = serverNow;
    return data;
  }, async (err, committed, snapshot)=>{
    if(err){ console.error(err); showToast('Terjadi kesalahan'); return; }
    if(!committed){ showToast('Tidak berhasil: cooldown/limit'); return; }
    // transaction succeeded -> write history to Firestore (non-critical)
    const doc = {
      uid: user.uid,
      type: 'earn',
      amount: 1,
      ts: await getServerTime(),
      deviceId,
      ip: await fetchIP(),
      source: 'button'
    };
    writeHistoryToFirestore(doc);
    showToast('+1 berhasil');
  });
});

bonusBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user) { showToast('Silakan login'); openAuth(); return; }
  if(bonusBtn.classList.contains('disabled')) { showToast('Bonus masih cooldown'); return; }
  const ref = rdb.ref('users/'+user.uid);
  const serverNow = await getServerTime();

  ref.transaction(data=>{
    if(!data) return;
    const resetBoundary = (()=>{ const d=new Date(serverNow); d.setHours(6,0,0,0); if(serverNow < d.getTime()) d.setDate(d.getDate()-1); return d.getTime(); })();
    if(!data.lastResetAt || data.lastResetAt < resetBoundary){ data.earnUsedToday=0; data.bonusUsedToday=0; data.lastResetAt=serverNow; }

    if((data.bonusUsedToday||0) >= BONUS_MAX) { return; }
    if(serverNow < (data.nextBonusAt||0)) { return; }

    data.balance = (data.balance||0) + 30;
    data.bonusUsedToday = (data.bonusUsedToday||0) + 1;
    data.nextBonusAt = serverNow + COOLDOWN;
    data.lastActionAt = serverNow;
    return data;
  }, async (err, committed, snapshot)=>{
    if(err){ console.error(err); showToast('Terjadi kesalahan'); return; }
    if(!committed){ showToast('Tidak berhasil: cooldown/limit'); return; }
    const doc = {
      uid: user.uid,
      type: 'bonus',
      amount: 30,
      ts: await getServerTime(),
      deviceId,
      ip: await fetchIP(),
      source: 'button'
    };
    writeHistoryToFirestore(doc);
    showToast('+30 berhasil');
  });
});

/* ============== helper: show banned ============== */
function showBanned(){ bannedEl.style.display='flex'; showToast('Akun dibanned',4000); }

/* ============== initial actions ============== */
window.addEventListener('load', ()=>{ // open auth modal if not authed
  setTimeout(()=>{ if(!auth.currentUser) openAuth(); }, 700);
});
</script>
</body>
</html>