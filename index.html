<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NusaTask • Bot Earning (Final)</title>

  <!-- Firebase v8 (compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Tailwind (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <!-- Inter font (opsional agar lebih profesional) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2e;
      --muted:#9aa4b2;
      --accent:#6d6ffb;
      --accent2:#9b6dfb;
      --ok:#23c55e;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:radial-gradient(1200px 600px at 10% 0%,rgba(109,111,251,.12),transparent),
                    radial-gradient(1000px 500px at 90% 10%,rgba(155,109,251,.12),transparent),
                    var(--bg);
         font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
         color:#e5e7eb; overflow-x:hidden}

    /* Kartu & tombol */
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
          border:1px solid rgba(255,255,255,.06);
          border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:12px;
         padding:.9rem 1rem; font-weight:800; letter-spacing:.2px}
    .btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.3)}
    .btn-secondary{background:linear-gradient(90deg,#3b82f6,#8b5cf6)}

    /* Animasi halus */
    .fade-in{animation:fade .35s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .pulse{animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.45}50%{opacity:1}}

    /* Loading overlay */
    #loadingOverlay{position:fixed; inset:0; display:grid; place-items:center; z-index:60;
      background:rgba(5,8,15,.86); backdrop-filter:blur(4px)}
    .spinner{width:56px;height:56px;border-radius:9999px;border:5px solid rgba(255,255,255,.15);
             border-top-color:#7c7dff; animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Block overlay */
    #blockedOverlay{position:fixed; inset:0; z-index:70; display:none; place-items:center;
      background:rgba(9,14,25,.94); backdrop-filter:blur(2px)}

    /* Toast (notif profesional) */
    #toastWrap{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:80}
    .toast{min-width:240px; max-width:90vw; background:#0f172a; border:1px solid rgba(255,255,255,.08);
           padding:12px 14px; border-radius:12px; display:flex; gap:10px; align-items:flex-start;
           box-shadow:0 20px 40px rgba(0,0,0,.35); animation:toastIn .28s ease both}
    .toast.ok{border-color:rgba(35,197,94,.35)}
    .toast.warn{border-color:rgba(245,158,11,.35)}
    .toast.err{border-color:rgba(239,68,68,.35)}
    .toast .title{font-weight:800}
    .toast .desc{font-size:.85rem; color:var(--muted)}
    @keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Input */
    .field{background:#0c1426; border:1px solid rgba(255,255,255,.08); border-radius:12px; color:#fff}
    .field:focus{outline:none; border-color:#5262ff; box-shadow:0 0 0 3px rgba(82,98,255,.25)}

    /* Badge kecil */
    .badge{font-size:.7rem; padding:.25rem .5rem; border-radius:9999px; background:rgba(255,255,255,.06); color:#cbd5e1}
  </style>
</head>
<body>

  <!-- LOADING OVERLAY (menu loading) -->
  <div id="loadingOverlay" class="fade-in" aria-hidden="true">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-sm text-gray-300">Memuat…</p>
      <p class="text-xs text-gray-500 mt-1">Mohon tunggu sebentar</p>
    </div>
  </div>

  <!-- AUTH CARD -->
  <main class="min-h-screen w-full flex items-center justify-center p-5">
    <section id="authSection" class="card fade-in w-full max-w-md p-7">
      <header class="mb-6">
        <h1 class="text-2xl font-extrabold">NusaTask <span class="badge">Secure</span></h1>
        <p class="text-sm text-gray-400 mt-1">Masuk untuk mulai menghasilkan.</p>
      </header>

      <div class="space-y-3">
        <input id="email" type="email" class="field w-full p-3" placeholder="Email"/>
        <input id="password" type="password" class="field w-full p-3" placeholder="Password (min 6 karakter)"/>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <button id="registerBtn" class="btn-secondary btn">Daftar</button>
        <button id="loginBtn" class="btn">Login</button>
      </div>

      <p id="authMsg" class="text-sm text-red-400 min-h-[1.25rem] mt-3"></p>

      <footer class="mt-6 text-xs text-gray-400">
        Keamanan aktif: 1 Akun/Device • Anti VPN/Proxy • Cooldown Persisten • Reset 07:00 WIB
      </footer>
    </section>

    <!-- DASHBOARD -->
    <section id="dashSection" class="hidden card fade-in w-full max-w-md p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-extrabold">Dashboard</h2>
          <p class="text-xs text-gray-400">Akun aman & tervalidasi</p>
        </div>
        <span class="badge">Realtime</span>
      </div>

      <div class="mt-5 p-5 rounded-xl" style="background:#0c1426;border:1px solid rgba(255,255,255,.06)">
        <p class="text-sm text-gray-300">Saldo</p>
        <p id="saldo" class="text-3xl font-extrabold text-green-400">Rp 0</p>
        <p id="countInfo" class="text-xs text-gray-400 mt-1">0/20 klik hari ini • reset 07:00 WIB</p>
      </div>

      <div class="mt-5 space-y-3">
        <button id="earnBtn"  class="btn w-full">Menghasilkan</button>
        <button id="bonusBtn" class="btn w-full">Xstra Bonus</button>
      </div>

      <div class="mt-4 text-sm text-gray-300 min-h-[1.25rem]">
        <span id="hint" class="pulse">Tip: setiap tombol memiliki cooldown 3 menit.</span>
      </div>
    </section>
  </main>

  <!-- BLOKIR OVERLAY -->
  <div id="blockedOverlay">
    <div class="card p-8 text-center max-w-sm">
      <h3 class="text-2xl font-extrabold mb-2">Akun Diblokir</h3>
      <p class="text-gray-300">Hubungi admin <span class="text-indigo-400 font-bold">@nusataskproject</span></p>
    </div>
  </div>

  <!-- TOAST WRAPPER -->
  <div id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ================================================================
   KONFIGURASI FIREBASE (gunakan project kamu)
================================================================ */
const firebaseConfig = {
  apiKey:"AIzaSyAUcac_uXdofDbqPwltgb4m7qIPiQhJi0s",
  authDomain:"nusataskproject.firebaseapp.com",
  databaseURL:"https://nusataskproject-default-rtdb.firebaseio.com",
  projectId:"nusataskproject",
  storageBucket:"nusataskproject.firebasestorage.app",
  messagingSenderId:"409602188456",
  appId:"1:409602188456:web:6302d3030b763324e28e9d",
  measurementId:"G-9389QL1WRE"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ================================================================
   QUERY ELEMENT UI
================================================================ */
const loadingOverlay = document.getElementById("loadingOverlay");
const authSection    = document.getElementById("authSection");
const dashSection    = document.getElementById("dashSection");
const blockedOverlay = document.getElementById("blockedOverlay");

const emailEl   = document.getElementById("email");
const passEl    = document.getElementById("password");
const loginBtn  = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const authMsg   = document.getElementById("authMsg");

const saldoEl   = document.getElementById("saldo");
const countInfo = document.getElementById("countInfo");
const earnBtn   = document.getElementById("earnBtn");
const bonusBtn  = document.getElementById("bonusBtn");
const hintEl    = document.getElementById("hint");

/* ================================================================
   UTIL - TOAST NOTIFICATION (profesional)
================================================================ */
const toastWrap = document.getElementById("toastWrap");
/**
 * type: ok | warn | err | info (default ok)
 */
function showToast({title="Berhasil", desc="", type="ok", timeout=3000}={}){
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  el.innerHTML = `
    <div>
      <div class="title">${title}</div>
      ${desc ? `<div class="desc">${desc}</div>` : ``}
    </div>
  `;
  toastWrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, timeout-250);
  setTimeout(()=>{ el.remove(); }, timeout);
}

/* ================================================================
   UTIL - WAKTU JAKARTA via HTTPS (anti manipulasi jam HP)
================================================================ */
let cachedTime = null, lastFetch = 0;
async function nowJakarta(){
  const now = Date.now();
  if (cachedTime && (now - lastFetch) < 60_000) return new Date(cachedTime);
  try{
    const r = await fetch("https://worldtimeapi.org/api/timezone/Asia/Jakarta");
    const j = await r.json();
    cachedTime = j.datetime;
    lastFetch = Date.now();
    return new Date(j.datetime);
  }catch(e){
    // fallback lokal jika API bermasalah
    return new Date();
  }
}
function dayKey(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

/* ================================================================
   ANTI CLONING: DEVICE LOCK
================================================================ */
function deviceId(){
  return navigator.userAgent + "|" + screen.width + "x" + screen.height;
}
async function enforceDevice(uid){
  const id = deviceId();
  const ref = db.ref("devices/"+uid);
  const snap = await ref.once("value");
  if (!snap.exists()){
    await ref.set(id);
  } else if (snap.val() !== id){
    await db.ref("blocked/"+uid).set(true);
    showToast({title:"Akses ditolak", desc:"Login dari device berbeda terdeteksi.", type:"err", timeout:4500});
    await auth.signOut();
  }
}

/* ================================================================
   ANTI VPN/PROXY/HOSTING/TOR (HTTPS)
================================================================ */
async function enforceNoVPN(uid){
  try{
    const r = await fetch("https://ipapi.is/");
    const j = await r.json();
    const bad = j?.proxy || j?.vpn || j?.tor || j?.hosting || j?.is_proxy || j?.is_vpn || j?.is_tor || j?.is_hosting;
    if (bad){
      await db.ref("blocked/"+uid).set(true);
      showToast({title:"Terblokir", desc:"VPN/Proxy terdeteksi. Matikan VPN untuk melanjutkan.", type:"err", timeout:5000});
      await auth.signOut();
    }
  }catch(e){
    // jika gagal cek, lanjutkan tanpa memblokir
  }
}

/* ================================================================
   BLOKIR OVERLAY (Realtime)
================================================================ */
function listenBlocked(uid){
  db.ref("blocked/"+uid).on("value", snap=>{
    blockedOverlay.style.display = snap.exists() ? "grid" : "none";
  });
}

/* ================================================================
   SALDO / LIMIT / RESET HARIAN (07:00 WIB)
================================================================ */
function listenBalance(uid){
  db.ref("balances/"+uid).on("value", snap=>{
    const v = snap.val();
    if (!v) return;
    saldoEl.textContent = "Rp " + (v.saldo||0).toLocaleString("id-ID");
    countInfo.textContent = `${v.count||0}/20 klik hari ini • reset 07:00 WIB`;
  });
}

async function ensureDailyReset(uid){
  const now = await nowJakarta();
  const key = dayKey(now);
  const hour = now.getHours();
  const ref = db.ref("balances/"+uid);
  await ref.transaction(b=>{
    if (!b) b = {saldo:0,count:0,lastResetKey:""};
    if ((b.lastResetKey||"") !== key && hour >= 7){
      b.count = 0;
      b.lastResetKey = key;
    }
    return b;
  });
}

/* ================================================================
   COOLDOWN PERISTEN (Realtime DB)
   path: cooldowns/<uid>/{earn|bonus} = lastClickMs (epoch ms WIB)
================================================================ */
async function getCooldown(uid, type){
  const s = await db.ref(`cooldowns/${uid}/${type}`).once("value");
  return s.val() || 0;
}
async function setCooldown(uid, type, ms){
  await db.ref(`cooldowns/${uid}/${type}`).set(ms);
}

/* ================================================================
   REWARD HANDLER (Rp 30.000) + COOLDOWN 3 MENIT + LIMIT 20x
================================================================ */
async function handleReward(type){
  const user = auth.currentUser;
  if (!user) return;
  // tampilkan loading kecil di tombol
  const btn = (type==="earn") ? earnBtn : bonusBtn;
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "Memproses…";
  hintEl.textContent = "";

  try{
    const now = await nowJakarta();
    const nowMs = now.getTime();

    // cek cooldown
    const last = await getCooldown(user.uid, type);
    const remain = 180000 - (nowMs - last); // 3 menit = 180000 ms
    if (remain > 0){
      const sec = Math.ceil(remain/1000);
      showToast({title:"Cooldown", desc:`Silakan tunggu ${sec} detik sebelum menekan tombol ini lagi.`, type:"warn", timeout:3500});
      return;
    }

    await ensureDailyReset(user.uid);

    // transaksi saldo & limit
    const ref = db.ref("balances/"+user.uid);
    let limited = false;
    let newCount = 0;
    await ref.transaction(b=>{
      if (!b) b = {saldo:0,count:0,lastResetKey:""};
      const todayKey = dayKey(now);
      if (b.lastResetKey !== todayKey && now.getHours() >= 7){
        b.count = 0;
        b.lastResetKey = todayKey;
      }
      if (b.count >= 20){ limited = true; return b; }
      b.saldo = (b.saldo||0) + 30000;
      b.count = (b.count||0) + 1;
      newCount = b.count;
      return b;
    });

    if (limited){
      showToast({title:"Limit tercapai", desc:"Batas 20x telah tercapai. Reset pukul 07:00 WIB.", type:"warn", timeout:4500});
      return;
    }

    // set cooldown baru
    await setCooldown(user.uid, type, nowMs);

    // sukses
    showToast({title:"+ Rp 30.000", desc:`Transaksi berhasil. Klik ke-${newCount} hari ini.`, type:"ok", timeout:3000});
  }catch(e){
    showToast({title:"Gagal", desc:"Terjadi kendala. Coba lagi beberapa saat.", type:"err", timeout:4000});
  }finally{
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

/* ================================================================
   AUTH: LOGIN & REGISTER (dipisah)
================================================================ */
loginBtn.addEventListener("click", async ()=>{
  const email = emailEl.value.trim();
  const pass  = passEl.value;
  if (!email || !pass){
    showToast({title:"Mohon lengkapi", desc:"Email & password wajib diisi.", type:"warn"});
    return;
  }
  if (pass.length < 6){
    showToast({title:"Password lemah", desc:"Minimal 6 karakter.", type:"warn"});
    return;
  }
  loadingOverlay.style.display = "grid";
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    showToast({title:"Login gagal", desc:e.message||"Periksa data Anda.", type:"err", timeout:4500});
  }finally{
    loadingOverlay.style.display = "none";
  }
});

registerBtn.addEventListener("click", async ()=>{
  const email = emailEl.value.trim();
  const pass  = passEl.value;
  if (!email || !pass){
    showToast({title:"Mohon lengkapi", desc:"Email & password wajib diisi.", type:"warn"});
    return;
  }
  if (pass.length < 6){
    showToast({title:"Password lemah", desc:"Minimal 6 karakter.", type:"warn"});
    return;
  }
  loadingOverlay.style.display = "grid";
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.ref("balances/"+cred.user.uid).set({saldo:0,count:0,lastResetKey:""});
    showToast({title:"Pendaftaran berhasil", desc:"Akun Anda siap digunakan.", type:"ok"});
  }catch(e){
    showToast({title:"Daftar gagal", desc:e.message||"Periksa data Anda.", type:"err", timeout:4500});
  }finally{
    loadingOverlay.style.display = "none";
  }
});

/* ================================================================
   AUTH STATE
   - Atur UI
   - Enforce device & anti VPN
   - Pasang listener blokir & balance
   - Pastikan reset harian
================================================================ */
auth.onAuthStateChanged(async (user)=>{
  if (user){
    // Tampilkan loading sebentar saat inisialisasi sesi
    loadingOverlay.style.display = "grid";

    // Sembunyikan form, tampilkan dashboard
    authSection.classList.add("hidden");
    dashSection.classList.remove("hidden");

    // Keamanan
    await enforceDevice(user.uid);
    await enforceNoVPN(user.uid);

    // Listener realtime
    listenBlocked(user.uid);
    listenBalance(user.uid);

    // Reset harian (jika perlu)
    await ensureDailyReset(user.uid);

    // Selesai loading
    loadingOverlay.style.display = "none";
  } else {
    // Kembali ke form auth
    dashSection.classList.add("hidden");
    authSection.classList.remove("hidden");
    blockedOverlay.style.display = "none";
  }
});

/* ================================================================
   ACTION BUTTONS
================================================================ */
earnBtn.addEventListener("click", ()=> handleReward("earn"));
bonusBtn.addEventListener("click", ()=> handleReward("bonus"));

</script>
</body>
</html>