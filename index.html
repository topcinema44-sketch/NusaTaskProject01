<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask - Earning</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      background: rgba(0,0,0,0.7);
      padding: 25px;
      border-radius: 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      animation: fadeIn 1s ease;
    }
    input, button {
      margin: 8px 0;
      padding: 12px;
      width: 90%;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      outline: none;
    }
    input { background: #f1f1f1; color: black; }
    button {
      cursor: pointer;
      transition: 0.3s;
    }
    button:disabled {
      background: grey !important;
      cursor: not-allowed;
    }
    .authBtn { background: #ff9800; color: white; }
    .reward { background: #28a745; color: white; }
    .xstra { background: #007bff; color: white; }
    button:hover:not(:disabled) { transform: scale(1.05); }
    #notif {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
      animation: fadeInOut 4s ease;
    }
    #loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      z-index: 1000;
    }
    .progress {
      background: #333;
      border-radius: 10px;
      height: 15px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-bar {
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes fadeInOut { 0%{opacity:0;} 10%{opacity:1;} 90%{opacity:1;} 100%{opacity:0;} }
    #dashboard { display: none; }
  </style>
</head>
<body>
<div id="loading">‚è≥ Loading...</div>

<div class="container">
  <!-- üîë AUTH BOX -->
  <div class="card" id="authBox">
    <h2>Login NusaTask</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button class="authBtn" onclick="register()">Daftar</button>
    <button class="authBtn" onclick="login()">Login</button>
  </div>

  <!-- üèÜ DASHBOARD -->
  <div class="card" id="dashboard">
    <h2>NusaTask - Earning</h2>
    <p id="saldo">Saldo: Rp0</p>

    <h3>Ambil Reward</h3>
    <button id="reward1" class="reward">Ambil Reward 1</button>
    <button id="reward2" class="reward">Ambil Reward 2</button>
    <div class="progress"><div id="progressReward" class="progress-bar"></div></div>

    <h3>Xstra Bonus</h3>
    <button id="xstra1" class="xstra">Xstra Bonus 1</button>
    <button id="xstra2" class="xstra">Xstra Bonus 2</button>
    <div class="progress"><div id="progressXstra" class="progress-bar"></div></div>

    <div id="notif"></div>
  </div>
</div>

<script>
  // üîë Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
    authDomain: "penyimpanansaldo-280df.firebaseapp.com",
    databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "penyimpanansaldo-280df",
    storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
    messagingSenderId: "659609775130",
    appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
    measurementId: "G-L4TW7E23H2"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  let userId, userStatus = "active";

  // üöÄ Register
  function register() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(email, pass)
      .then(user => {
        userId = user.user.uid;
        const deviceId = navigator.userAgent;
        fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(ip => {
            db.ref("users/" + userId).set({
              email, saldo: 0, status: "active",
              createdAt: Date.now(),
              deviceId, ip: ip.ip
            });
          });
        showNotif("Registrasi sukses!", "green");
      })
      .catch(err => showNotif(err.message, "red"));
  }

  // üöÄ Login
  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, pass)
      .catch(err => showNotif(err.message, "red"));
  }

  // üîÑ Auto-login & cek status
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      db.ref("users/" + userId).on("value", snap => {
        const data = snap.val();
        if (!data) return;
        userStatus = data.status;

        // üö´ Device check (anti tuyul)
        const deviceId = navigator.userAgent;
        if (data.deviceId !== deviceId) {
          db.ref("users/" + userId + "/status").set("banned");
          disableAllButtons();
          saldo.innerText = "Saldo: üö´ Diblokir";
          return showNotif("üö´ Device berbeda! Akun dibanned", "red");
        }

        // ‚ö†Ô∏è IP check (warning saja)
        fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(ip => {
            if (data.ip !== ip.ip) {
              showNotif("‚ö†Ô∏è IP berbeda, akun dipantau", "orange");
            }
          });

        if (userStatus === "banned") {
          disableAllButtons();
          saldo.innerText = "Saldo: üö´ Diblokir";
          return;
        }

        // aktif ‚Üí saldo realtime
        saldo.innerText = "Saldo: Rp" + (data.saldo || 0).toLocaleString();
        enableAllButtons();
      });
      authBox.style.display = "none";
      dashboard.style.display = "block";
      loading.style.display = "none";
    } else {
      authBox.style.display = "block";
      dashboard.style.display = "none";
      loading.style.display = "none";
    }
  });

  // üö¶ Tombol reward/bonus
  function handleClick(btnId, type) {
    if (userStatus === "banned") {
      showNotif("üö´ Anda dibanned!", "red");
      return;
    }
    const btn = document.getElementById(btnId);
    const cooldownRef = db.ref("cooldowns/" + userId + "/" + btnId);
    const dailyRef = db.ref("daily/" + userId + "/" + btnId);

    cooldownRef.once("value", cSnap => {
      const now = Date.now();
      const cooldownEnd = cSnap.val() || 0;
      if (now < cooldownEnd) {
        const sisa = Math.ceil((cooldownEnd - now) / 1000);
        return showNotif("‚è≥ Tunggu " + sisa + " detik lagi", "orange");
      }

      dailyRef.once("value", dSnap => {
        let data = dSnap.val() || { count: 0, lastReset: new Date().toDateString() };

        // reset harian jam 3 pagi
        const today = new Date();
        if (today.getHours() >= 3) {
          if (data.lastReset !== today.toDateString()) {
            data = { count: 0, lastReset: today.toDateString() };
          }
        }

        if (data.count >= 20) {
          return showNotif("‚ö†Ô∏è Limit harian tercapai", "red");
        }

        // üí∞ Tambah saldo
        const reward = (type === "reward") ? 200 : 500;
        const saldoRef = db.ref("users/" + userId + "/saldo");
        saldoRef.transaction(saldo => (saldo || 0) + reward);

        // ‚è±Ô∏è Cooldown 2 menit
        cooldownRef.set(Date.now() + 2*60*1000);
        dailyRef.set({ count: data.count + 1, lastReset: data.lastReset });

        showNotif("‚úÖ Klaim Rp" + reward, "green");
        startCooldown(btn, 120);
        updateProgress(type, data.count + 1);
      });
    });
  }

  // ‚è±Ô∏è Cooldown tombol
  function startCooldown(btn, durasi) {
    btn.disabled = true;
    let sisa = durasi, asli = btn.innerText;
    const timer = setInterval(() => {
      btn.innerText = "‚è≥ " + sisa + "s";
      if (sisa-- <= 0) {
        clearInterval(timer);
        btn.disabled = false;
        btn.innerText = asli;
      }
    }, 1000);
  }

  // üìä Progress bar
  function updateProgress(type, count) {
    const persen = (count / 20) * 100;
    if (type === "reward") {
      document.getElementById("progressReward").style.width = persen + "%";
    } else {
      document.getElementById("progressXstra").style.width = persen + "%";
    }
  }

  // üîî Notifikasi
  function showNotif(msg, color) {
    const n = document.getElementById("notif");
    n.style.display = "block";
    n.style.background = color;
    n.innerText = msg;
    setTimeout(() => { n.style.display = "none"; }, 4000);
  }

  function disableAllButtons() {
    ["reward1","reward2","xstra1","xstra2"].forEach(id=>{
      document.getElementById(id).disabled = true;
    });
  }
  function enableAllButtons() {
    ["reward1","reward2","xstra1","xstra2"].forEach(id=>{
      document.getElementById(id).disabled = false;
    });
  }

  // üéØ Event tombol
  reward1.onclick = () => handleClick("reward1","reward");
  reward2.onclick = () => handleClick("reward2","reward");
  xstra1.onclick = () => handleClick("xstra1","xstra");
  xstra2.onclick = () => handleClick("xstra2","xstra");
</script>
</body>
</html>
