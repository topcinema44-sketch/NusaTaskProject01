<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NusaTask ‚Äî All in One</title>

  <!-- ====== Fonts & Simple CSS ====== -->
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#172039; --muted:#94a3b8;
      --text:#e5e7eb; --primary:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --gold:#f59e0b; --accent:#8b5cf6; --cool:#111827; --cool-text:#9ca3af;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b1220;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
    .wrap{max-width:980px;margin:16px auto;padding:12px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px;margin-bottom:14px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .title{font-weight:700;font-size:20px;margin:0 0 8px}
    .muted{color:var(--muted);font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1328;border:1px solid #1f2a44;color:#cbd5e1;border-radius:999px;padding:6px 12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;text-align:center;border:0;border-radius:12px;padding:14px 12px;
         background:var(--primary);color:#fff;font-weight:700;cursor:pointer;transition:.2s}
    .btn:disabled{cursor:not-allowed;opacity:1}
    .btn.cooldown{background:var(--cool);color:var(--cool-text);border:1px dashed #334155}
    .btn.warn{background:var(--danger)}
    .btn.gold{background:var(--gold);color:#111}
    .btn.accent{background:var(--accent)}
    .btn.ok{background:var(--ok)}
    .chip{font-weight:700;background:#0b1328;border:1px solid #1f2a44;color:#e5e7eb;border-radius:10px;padding:8px 10px}
    .avatar{width:52px;height:52px;border-radius:999px;background:#1f2937;display:flex;align-items:center;justify-content:center;font-weight:800}
    input,select{width:100%;background:#0b1328;border:1px solid #1f2a44;color:#e5e7eb;border-radius:12px;padding:14px;font-size:16px}
    label{font-size:14px;color:#a3b2c5;margin-bottom:6px;display:block}
    .space{height:8px}
    .topgrid{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .saldo{display:flex;flex-direction:column;align-items:flex-end}
    .saldo b{font-size:22px}
    .grid-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .footer{color:#8ea0bd;text-align:center;font-size:12px;margin:12px 0}
    .hidden{display:none !important}
    .center{text-align:center}
    .badge{font-size:12px;padding:3px 8px;border-radius:8px;background:#0e162b;border:1px solid #22304a}
    .link{color:#93c5fd;text-decoration:none}
    .hr{height:1px;background:#1f2a44;margin:12px 0}
  </style>

  <!-- ===== Telegram Mini App (untuk Adexium) ===== -->
  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>

  <!-- ====== AD SDKs ====== -->
  <!-- RichAds (TelegramAdsController) -->
  <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>

  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9779635' data-sdk='show_9779635'></script>

  <!-- Adexium SDK -->
  <script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

  <!-- ====== Firebase v10 (modular) ====== -->
  <script type="module" id="app-script">
    /********* IMPORTS *********/
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, Timestamp,
      collection, addDoc, query, where, orderBy, onSnapshot, increment, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /********* FIREBASE CONFIG (punyamu) *********/
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    setPersistence(auth, browserLocalPersistence);

    /********* TELEGRAM NOTIF (punyamu) *********/
    const TELEGRAM_BOT_TOKEN = "8236562243:AAFIyLCk2fu9-4GxxYSuIoSKw9DEiv1DVko";
    const TELEGRAM_CHAT_ID   = "8322802091";

    /********* HELPERS UI *********/
    const $  = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove("hidden");
    const hide = (el)=>el.classList.add("hidden");
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    // toLocale ‚Äúid-ID‚Äù
    const rupiah = (n)=> (n||0).toLocaleString("id-ID");

    // Reset harian jam 03:00 WIB
    function dayKeyWithReset(date = new Date()){
      const d = new Date(date);
      // WIB = UTC+7; kita pakai lokal user tapi reset 03:00 lokal agar stabil
      const resetHour = 3;
      if (d.getHours() < resetHour){
        d.setDate(d.getDate()-1);
      }
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day= String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    /********* STATE *********/
    const BTN_IDS = [
      // id, label, tipe, provider
      ["earn_richads",  "Menghasilkan (RichAds)",  "ad",  "richads"],
      ["earn_monetag",  "Menghasilkan (Monetag)",  "ad",  "monetag"],
      ["earn_adexium",  "Menghasilkan (Adexium)",  "ad",  "adexium"],
      ["xstra_1",       "Xstra Bonus 1",           "xstra","x1"],
      ["xstra_2",       "Xstra Bonus 2",           "xstra","x2"],
      ["xstra_3",       "Xstra Bonus 3",           "xstra","x3"],
    ];
    const COOLDOWN_MS = 3 * 60 * 1000; // 3 menit
    const DAILY_LIMIT = 20;
    const REWARD_MAIN = 30000;   // contoh reward; silakan ubah
    const REWARD_XTRA = 10000;

    let currentUser = null;
    let userDocRef  = null;
    let adexiumWidget = null;

    /********* INIT ADEXIUM *********/
    document.addEventListener('DOMContentLoaded', () => {
      try{
        adexiumWidget = new AdexiumWidget({wid:'b78f386d-0a18-43d6-b658-27055787953f', adFormat:'interstitial'});
        adexiumWidget.autoMode();
      }catch(e){}
    });

    /********* AUTH FLOW (Auto Login) *********/
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser = user;
        userDocRef = doc(db,"users",user.uid);
        // init doc if missing
        const snap = await getDoc(userDocRef);
        if(!snap.exists()){
          await setDoc(userDocRef,{
            email:user.email, saldo:0, createdAt:serverTimestamp()
          });
        }
        await renderHome();
      }else{
        currentUser = null;
        renderAuth();
      }
    });

    // === RENDER AUTH PAGE ===
    function renderAuth(){
      hide($("homePage"));
      show($("authPage"));
      $("loginBtn").onclick = async ()=>{
        const email = $("loginEmail").value.trim();
        const pass  = $("loginPass").value.trim();
        if(!email || !pass){return alert("Lengkapi email & password");}
        try{
          await signInWithEmailAndPassword(auth,email,pass);
        }catch(e){
          alert("Login gagal: "+(e?.message||e));
        }
      };
      $("registerBtn").onclick = async ()=>{
        const email = $("regEmail").value.trim();
        const pass  = $("regPass").value.trim();
        if(pass.length<6) return alert("Password minimal 6 karakter");
        try{
          await createUserWithEmailAndPassword(auth,email,pass);
          alert("Akun dibuat. Kamu sudah login.");
        }catch(e){
          alert("Register gagal: "+(e?.message||e));
        }
      };
    }

    // === RENDER HOME ===
    async function renderHome(){
      hide($("authPage"));
      show($("homePage"));

      // header
      $("headEmail").textContent = currentUser.email || "(tanpa email)";
      $("headInit").textContent = (currentUser.email||"U")[0]?.toUpperCase()||"U";

      // saldo
      const u = await getDoc(userDocRef);
      const saldo = u.data()?.saldo||0;
      $("saldoVal").textContent = "Rp "+rupiah(saldo);

      // counter harian
      await refreshDailyChips();

      // tombol aksi
      $("btnLogout").onclick = ()=>signOut(auth);
      $("btnTheme").onclick  = ()=>document.body.classList.toggle("light");
      $("btnHelp").onclick   = ()=>window.open("https://t.me/senditaofficial","_blank");
      $("btnYt").onclick     = ()=>window.open("LINK_YOUTUBE","_blank");
      $("btnIg").onclick     = ()=>window.open("LINK_INSTAGRAM","_blank");

      // WD
      $("btnWithdraw").onclick = submitWithdraw;
      $("btnRiwayat").onclick  = openRiwayat;
      $("btnBackRw").onclick   = ()=>{ hide($("riwayatPage")); show($("homePage")); };

      // siapkan tombol iklan
      BTN_IDS.forEach(([id,label,type,prov])=>{
        const btn = $(id);
        btn.textContent = label;
        btn.onclick = ()=>handleEarn(id,type,prov,btn);
        // pulihkan countdown bila ada
        hydrateCooldown(id, btn);
      });
    }

    /********* DAILY STATE *********/
    function localKey(id){
      if(!currentUser) return "";
      return `CD_${currentUser.uid}_${dayKeyWithReset()}_${id}`;
    }
    function hydrateCooldown(id,btn){
      const k = localKey(id);
      const until = Number(localStorage.getItem(k)||0);
      const left = until - Date.now();
      if(left>0){ startCooldown(btn,id,left); }
    }
    async function refreshDailyChips(){
      const dkey = dayKeyWithReset();
      const dailyRef = doc(db,"users",currentUser.uid,"daily",dkey);
      let snap = await getDoc(dailyRef);
      if(!snap.exists()){
        await setDoc(dailyRef,{
          ts:serverTimestamp(),
          earn_richads:0, earn_monetag:0, earn_adexium:0,
          xstra_1:0, xstra_2:0, xstra_3:0
        });
        snap = await getDoc(dailyRef);
      }
      const data = snap.data()||{};
      $("chip_main").textContent   = `Menghasilkan: ${(data.earn_richads+data.earn_monetag+data.earn_adexium)||0}/20`;
      $("chip_x1").textContent     = `Xstra 1: ${data.xstra_1||0}/20`;
      $("chip_x2").textContent     = `Xstra 2: ${data.xstra_2||0}/20`;
      $("chip_x3").textContent     = `Xstra 3: ${data.xstra_3||0}/20`;
      $("chip_mon").textContent    = `Monetag: ${data.earn_monetag||0}/20`;
      $("chip_adx").textContent    = `Adexium: ${data.earn_adexium||0}/20`;
    }

    async function incDaily(id){
      const dkey = dayKeyWithReset();
      const ref  = doc(db,"users",currentUser.uid,"daily",dkey);
      await updateDoc(ref,{ [id]: increment(1) });
      await refreshDailyChips();
    }

    async function getDailyCount(id){
      const dkey = dayKeyWithReset();
      const ref  = doc(db,"users",currentUser.uid,"daily",dkey);
      const snap = await getDoc(ref);
      return (snap.data()?.[id])||0;
    }

    /********* COOLDOWN *********/
    function startCooldown(btn,id,msLeft=COOLDOWN_MS){
      const end = Date.now()+msLeft;
      localStorage.setItem(localKey(id), String(end));
      btn.classList.add("cooldown");
      btn.disabled = true;

      const baseText = btn.dataset.base || btn.textContent;
      btn.dataset.base = baseText;

      const tick = ()=>{
        const left = end - Date.now();
        if(left<=0){
          btn.textContent = baseText;
          btn.classList.remove("cooldown");
          btn.disabled = false;
          localStorage.removeItem(localKey(id));
          return;
        }
        const s = Math.ceil(left/1000);
        const m = String(Math.floor(s/60)).padStart(2,"0");
        const ss= String(s%60).padStart(2,"0");
        btn.textContent = `${baseText} ¬∑ ${m}:${ss}`;
        requestAnimationFrame(tick);
      };
      tick();
    }

    /********* HANDLE EARN *********/
    async function handleEarn(id,type,prov,btn){
      // cek limit harian
      const cnt = await getDailyCount(id);
      if(cnt>=DAILY_LIMIT){ return alert("Sudah mencapai batas harian (20x)."); }

      // tampilkan iklan sesuai provider
      try{
        if(type==="ad"){
          if(prov==="richads"){
            await showRichAds();
          }else if(prov==="monetag"){
            await showMonetag();
          }else if(prov==="adexium"){
            await showAdexium();
          }
          await grantReward(REWARD_MAIN);
        }else{ // xstra
          await sleep(800); // simulasi
          await grantReward(REWARD_XTRA);
        }
        await incDaily(id);
        startCooldown(btn,id);
      }catch(e){
        console.log("Ad error:", e);
        alert("Iklan gagal ditayangkan / dibatalkan.");
      }
    }

    // === PROVIDERS ===
    function showRichAds(){
      return new Promise((resolve,reject)=>{
        try{
          window.TelegramAdsController = new TelegramAdsController();
          window.TelegramAdsController.initialize({ pubId:"984631", appId:"3504" });
          // RichAds tidak expose promise selesai. Kita beri delay aman 12 detik.
          setTimeout(()=>resolve(), 12000);
        }catch(e){ reject(e); }
      });
    }

    function showMonetag(){
      return new Promise((resolve,reject)=>{
        try{
          // Monetag rewarded interstitial
          show_9779635().then(()=>{
            resolve();
          }).catch(reject);
        }catch(e){ reject(e); }
      });
    }

    function showAdexium(){
      return new Promise((resolve,reject)=>{
        try{
          // Adexium autoMode menayangkan sendiri; kita beri window 10 detik
          setTimeout(()=>resolve(), 10000);
        }catch(e){ reject(e); }
      });
    }

    // === REWARD ===
    async function grantReward(amount){
      await updateDoc(userDocRef,{ saldo: increment(amount) });
      const u = await getDoc(userDocRef);
      $("saldoVal").textContent = "Rp "+rupiah(u.data()?.saldo||0);
    }

    /********* WITHDRAW *********/
    async function submitWithdraw(){
      const walletType   = $("walletType").value;
      const walletNumber = $("walletNumber").value.trim();
      const amount       = parseInt($("wdAmount").value||"0",10);

      if(!walletNumber) return alert("Nomor e-wallet wajib diisi.");
      if(isNaN(amount) || amount<30000) return alert("Minimal WD Rp30.000.");

      const payload = {
        uid: currentUser.uid,
        email: currentUser.email,
        walletType, walletNumber, amount,
        status:"pending",
        createdAt: serverTimestamp()
      };
      try{
        await addDoc(collection(db,"withdraws"), payload);

        // Notif Telegram
        const text = `WD Baru%0Aemail: ${encodeURIComponent(currentUser.email)}%0Anominal: Rp ${rupiah(amount)}%0Awallet: ${walletType} ${encodeURIComponent(walletNumber)}`;
        fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${text}`);

        alert("Pengajuan WD terkirim. Status bisa dipantau di Riwayat.");
        $("wdAmount").value = "30000";
      }catch(e){
        alert("Gagal WD: "+(e?.message||e));
      }
    }

    /********* RIWAYAT WD *********/
    async function openRiwayat(){
      hide($("homePage"));
      show($("riwayatPage"));
      const list = $("rwList");
      list.innerHTML = `<div class="muted">Memuat...</div>`;

      const qy = query(
        collection(db,"withdraws"),
        where("uid","==", currentUser.uid),
        orderBy("createdAt","desc")
      );
      onSnapshot(qy,(snap)=>{
        if(snap.empty){
          list.innerHTML = `<div class="muted">Belum ada riwayat WD.</div>`;
          return;
        }
        list.innerHTML = "";
        snap.forEach(d=>{
          const wd = d.data();
          const t  = wd.createdAt?.toDate? wd.createdAt.toDate() : new Date();
          const time = t.toLocaleString("id-ID");
          const item = document.createElement("div");
          const color = wd.status==="success"?"ok":(wd.status==="pending"?"gold":"warn");
          item.className = "card";
          item.innerHTML = `
            <div class="topgrid">
              <div><b>${wd.walletType}</b><div class="muted">${wd.walletNumber}</div></div>
              <div class="center"><span class="badge">${time}</span></div>
              <div style="text-align:right"><span class="chip" style="background:transparent;border-color:transparent;color:#9fb7ff">Rp ${rupiah(wd.amount)}</span><br>
                <span class="badge" style="border-color:transparent;background:transparent;color:#fff">
                  <span class="btn ${color}" style="padding:6px 10px;border-radius:8px;font-size:12px">${wd.status}</span>
                </span>
              </div>
            </div>
          `;
          list.appendChild(item);
        });
      });
    }

    /********* EXPOSE FOR DEBUG (opsional) *********/
    window._dbg = {auth,db};
  </script>
</head>
<body>
  <div class="wrap">

    <!-- ====== AUTH PAGE ====== -->
    <section id="authPage" class="card hidden">
      <div class="title center">üîê Masuk / Daftar</div>
      <div class="hr"></div>

      <div class="row">
        <div class="card">
          <div class="title">Login</div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="email kamu" />
          <div class="space"></div>
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <div class="space"></div>
          <button class="btn" id="loginBtn">Login</button>
        </div>

        <div class="card">
          <div class="title">Register</div>
          <label>Email</label>
          <input id="regEmail" type="email" placeholder="email kamu" />
          <div class="space"></div>
          <label>Password</label>
          <input id="regPass" type="password" placeholder="minimal 6 karakter" />
          <div class="space"></div>
          <button class="btn ok" id="registerBtn">Buat Akun</button>
        </div>
      </div>

      <div class="footer">
        Iklan Hiltoads A ‚Ä¢ B ‚Ä¢ C ‚Ä¢ D (opsional slot banner)
      </div>
    </section>

    <!-- ====== HOME PAGE ====== -->
    <section id="homePage" class="hidden">
      <!-- Header -->
      <div class="card">
        <div class="topgrid">
          <div class="avatar" id="headInit">U</div>
          <div>
            <div style="font-weight:700" id="headEmail">user@mail.com</div>
            <div class="muted">Aktif</div>
          </div>
          <div class="saldo">
            <span class="muted">Saldo</span>
            <b id="saldoVal">Rp 0</b>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row3">
          <div class="chip" id="chip_main">Menghasilkan: 0/20</div>
          <div class="chip" id="chip_x1">Xstra 1: 0/20</div>
          <div class="chip" id="chip_x2">Xstra 2: 0/20</div>
          <div class="chip" id="chip_x3">Xstra 3: 0/20</div>
          <div class="chip" id="chip_mon">Monetag: 0/20</div>
          <div class="chip" id="chip_adx">Adexium: 0/20</div>
        </div>
      </div>

      <!-- Tombol Menghasilkan (6 tombol) -->
      <div class="card">
        <div class="title">Menghasilkan</div>
        <div class="muted">Setiap tombol punya cooldown <b>3 menit</b> & limit harian <b>20x</b>. Countdown tampil di tombol.</div>
        <div class="space"></div>
        <div class="row3">
          <button class="btn"         id="earn_richads">Menghasilkan (RichAds)</button>
          <button class="btn gold"    id="xstra_1">Xstra Bonus 1</button>
          <button class="btn accent"  id="xstra_2">Xstra Bonus 2</button>
          <button class="btn ok"      id="earn_monetag">Menghasilkan (Monetag)</button>
          <button class="btn"         id="xstra_3">Xstra Bonus 3</button>
          <button class="btn warn"    id="earn_adexium">Menghasilkan (Adexium)</button>
        </div>
      </div>

      <!-- Tombol Aksi -->
      <div class="card">
        <div class="title">Aksi</div>
        <div class="grid-actions">
          <button class="btn" id="btnTheme">Tema</button>
          <button class="btn" id="btnHelp">Help</button>
          <button class="btn warn" id="btnLogout">Logout</button>
          <button class="btn" id="btnYt" style="background:#0b0b0b">YouTube</button>
          <button class="btn" id="btnIg" style="background:#e11d48">Instagram</button>
          <button class="btn" id="btnRiwayat">Riwayat WD</button>
        </div>
      </div>

      <!-- Withdraw -->
      <div class="card">
        <div class="title">Withdraw</div>
        <div class="row">
          <div>
            <label>Metode</label>
            <select id="walletType">
              <option value="Dana">Dana</option>
              <option value="OVO">OVO</option>
              <option value="GoPay">GoPay</option>
              <option value="ShopeePay">ShopeePay</option>
            </select>
          </div>
          <div>
            <label>Nomor e-wallet</label>
            <input id="walletNumber" type="tel" placeholder="08xxxxxxxxxx" />
          </div>
        </div>
        <div class="space"></div>
        <label>Nominal</label>
        <input id="wdAmount" type="number" value="30000" step="1000" min="30000" />
        <div class="space"></div>
        <button class="btn ok" id="btnWithdraw">Ajukan WD (Min Rp30.000)</button>
        <div class="muted" style="margin-top:8px">Notifikasi WD dikirim ke Telegram admin. Statusnya cek di Riwayat WD.</div>
      </div>
    </section>

    <!-- ====== RIWAYAT PAGE ====== -->
    <section id="riwayatPage" class="hidden">
      <div class="card">
        <div class="topgrid">
          <div class="title" style="margin:0">Riwayat Withdraw</div>
          <div></div>
          <div style="text-align:right">
            <button class="btn" id="btnBackRw">Kembali</button>
          </div>
        </div>
      </div>
      <div id="rwList" class="wrap card"></div>
    </section>

    <div class="footer">¬© NusaTask ‚Äî semua fitur aktif. Jika ada yang tidak tampil, cek konsol browser.</div>
  </div>
</body>
</html>
