<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NusaTask — Earning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }
    .fade-in { animation: fadein .5s ease; } @keyframes fadein{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .disabled { opacity:.6; cursor:not-allowed; filter:grayscale(1); }
    .tick { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="mb-4 sm:mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700">NusaTask</h1>
      <p class="text-sm text-slate-500">Satu IP per device. Pelanggaran otomatis diblokir.</p>
    </header>

    <!-- Warning Before Enter -->
    <div id="gate" class="bg-white rounded-2xl p-5 shadow fade-in">
      <h2 class="text-lg font-semibold mb-2">Peringatan Anti-Tuyul</h2>
      <ul class="text-sm text-slate-600 list-disc ml-5 space-y-1">
        <li>Maksimal 1 akun per IP & per perangkat.</li>
        <li>Aktivitas emulator/otomasi akan diblokir otomatis.</li>
        <li>Limit harian reset pukul <strong>03:00 WIB</strong>.</li>
      </ul>

      <!-- Auth -->
      <div class="mt-4 grid gap-3">
        <input id="email" type="email" placeholder="Email"
               class="w-full rounded-xl border p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <input id="password" type="password" placeholder="Kata sandi"
               class="w-full rounded-xl border p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <div class="flex gap-2">
          <button id="btnLogin" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl shadow">
            Masuk / Daftar
          </button>
          <button id="btnContinue" class="flex-1 bg-slate-200 hover:bg-slate-300 p-3 rounded-xl">
            Lanjutkan
          </button>
        </div>
        <p id="authMsg" class="text-sm text-rose-600"></p>
      </div>
    </div>

    <!-- App -->
    <main id="app" class="hidden fade-in">
      <!-- Saldo Card -->
      <section class="bg-white rounded-2xl p-5 shadow mb-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-500">Saldo</p>
            <p id="saldo" class="text-3xl font-bold text-slate-800">Rp 0</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-slate-500">Sisa harian</p>
            <p class="text-sm">
              Menghasilkan: <span id="leftMeng" class="font-semibold">20</span> •
              Xstra: <span id="leftX" class="font-semibold">2</span>
            </p>
            <p class="text-xs text-slate-400">Reset 03:00 WIB</p>
          </div>
        </div>
      </section>

      <!-- Buttons -->
      <section class="grid gap-3">
        <!-- Menghasilkan -->
        <div class="bg-white rounded-2xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Menghasilkan</h3>
            <span id="cdMeng" class="text-xs tick text-slate-500"></span>
          </div>
          <button id="btnMeng"
                  class="w-full bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-xl shadow pulse">
            + Kerjakan (Monetag)
          </button>
          <!-- Monetag placeholder -->
          <div id="monetag-slot" class="mt-3"></div>
        </div>

        <!-- Xstra Bonus -->
        <div class="bg-white rounded-2xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Xstra Bonus</h3>
            <span id="cdX" class="text-xs tick text-slate-500"></span>
          </div>
          <button id="btnX"
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-xl shadow pulse">
            + Bonus (Clickadilla)
          </button>

          <!-- Clickadilla in-page placeholder -->
          <div id="clickad-inpage" class="mt-3"></div>
        </div>
      </section>

      <!-- Popunder anchor (Xstra after 4s) -->
      <iframe id="popunder-frame" class="hidden"></iframe>

      <!-- Status -->
      <p id="status" class="text-sm text-slate-500 mt-4"></p>
    </main>
  </div>

  <!-- Firebase JS SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref, get, set, update, onValue, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // === Firebase config (punyamu) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };

    // === Init ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    await setPersistence(auth, browserLocalPersistence);

    // === Helpers ===
    const el = id => document.getElementById(id);
    const fmtIDR = (n=0) => "Rp " + (n||0).toLocaleString("id-ID");
    const COOLDOWN_MS = 2 * 60 * 1000; // 2 menit
    const LIMIT_MENG = 20;
    const LIMIT_X = 2;
    const AWARD_MENG = 150; // silakan atur
    const AWARD_X = 500; // silakan atur

    // Reset cutoff 03:00 WIB
    function todayResetEpoch() {
      const now = new Date();
      // WIB offset +7
      const utc = now.getTime() + (now.getTimezoneOffset()*60000);
      const wib = new Date(utc + 7*3600*1000);
      const reset = new Date(wib);
      reset.setHours(3,0,0,0);
      if (wib.getTime() < reset.getTime()) {
        // sebelum 03:00 hari ini → pakai 03:00 hari ini
      } else {
        // sudah lewat → reset besok
        reset.setDate(reset.getDate()+1);
      }
      // kembali ke epoch UTC ms
      return reset.getTime() - 7*3600*1000; // konversi balik dari WIB ke UTC epoch
    }

    // === Anti Tuyul - simple UA & IP ===
    async function fetchIP() {
      try {
        const r = await fetch("https://api.ipify.org?format=json");
        const j = await r.json();
        return j.ip || null;
      } catch { return null; }
    }
    function looksLikeEmulator(ua) {
      const s = ua.toLowerCase();
      return /(headless|phantom|bot|crawler|spider)/.test(s);
    }

    // === Auth UI ===
    const gate = el("gate");
    const appView = el("app");
    const authMsg = el("authMsg");
    el("btnLogin").addEventListener("click", async () => {
      const email = el("email").value.trim();
      const password = el("password").value;
      if (!email || !password) { authMsg.textContent = "Email & kata sandi wajib."; return; }
      authMsg.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        if (e.code === "auth/user-not-found") {
          await createUserWithEmailAndPassword(auth, email, password);
        } else {
          authMsg.textContent = e.message;
        }
      }
    });
    el("btnContinue").addEventListener("click", () => {
      // jika sudah login, masuk; kalau belum, info
      if (!auth.currentUser) authMsg.textContent = "Silakan login/daftar dulu.";
    });

    // === Main state ===
    let currentUID = null;
    let userRef, dailyRef, cdRef;

    onAuthStateChanged(auth, async (user) => {
      if (!user) { gate.classList.remove("hidden"); appView.classList.add("hidden"); return; }
      currentUID = user.uid;
      userRef = ref(db, `users/${currentUID}`);
      dailyRef = ref(db, `users/${currentUID}/daily`);
      cdRef = ref(db, `users/${currentUID}/cooldowns`);

      // Anti tuyul: set IP & UA, index IP
      const ua = navigator.userAgent || "unknown";
      const ip = await fetchIP();
      const updates = {
        userAgent: ua,
        ip: ip || "unknown",
        status: looksLikeEmulator(ua) ? "banned" : "active",
        createdAt: Date.now(),
        daily: { menghasilkan: 0, xstra: 0, lastReset: Date.now() },
        cooldowns: { menghasilkan: 0, xstra: 0 },
        saldo: 0
      };
      // Inisialisasi hanya jika belum ada
      const snap = await get(userRef);
      if (!snap.exists()) await set(userRef, updates);

      // Tambahkan indeks IP (lihat rules ip_index di atas)
      if (ip) {
        await set(ref(db, `ip_index/${ip}/${currentUID}`), true);
      }

      // Jika status banned → blok
      const userData = (await get(userRef)).val();
      if (userData?.status === "banned") {
        authMsg.textContent = "Akun diblokir (anti-tuyul). Hubungi admin.";
        gate.classList.remove("hidden"); appView.classList.add("hidden"); return;
      }

      // Tampilkan app
      gate.classList.add("hidden");
      appView.classList.remove("hidden");
      bindRealtime();
    });

    function bindRealtime() {
      // Saldo + daily + cooldown + sisa
      onValue(userRef, (s) => {
        const v = s.val() || {};
        el("saldo").textContent = fmtIDR(v.saldo || 0);

        let meng = v.daily?.menghasilkan || 0;
        let x = v.daily?.xstra || 0;
        el("leftMeng").textContent = Math.max(0, LIMIT_MENG - meng);
        el("leftX").textContent = Math.max(0, LIMIT_X - x);

        drawCooldown("menghasilkan", v.cooldowns?.menghasilkan || 0, el("btnMeng"), el("cdMeng"));
        drawCooldown("xstra", v.cooldowns?.xstra || 0, el("btnX"), el("cdX"));

        // Reset harian bila melewati 03:00 WIB
        const nextReset = todayResetEpoch();
        const now = Date.now();
        const lastReset = v.daily?.lastReset || 0;
        if (now > nextReset && lastReset < nextReset) {
          // reset counters
          update(userRef, { daily: { menghasilkan: 0, xstra: 0, lastReset: nextReset }});
        }
      });
    }

    // === Cooldown renderer ===
    let timers = {};
    function drawCooldown(key, lastTs, btn, label) {
      const remain = COOLDOWN_MS - (Date.now() - (lastTs||0));
      if (remain > 0) {
        btn.classList.add("disabled"); btn.disabled = true;
        const endAt = Date.now() + remain;
        clearInterval(timers[key]);
        timers[key] = setInterval(() => {
          const left = Math.max(0, endAt - Date.now());
          label.textContent = "Cooldown " + Math.ceil(left/1000) + " dtk";
          if (left <= 0) { clearInterval(timers[key]); btn.classList.remove("disabled"); btn.disabled = false; label.textContent = ""; }
        }, 250);
      } else {
        btn.classList.remove("disabled"); btn.disabled = false; label.textContent = "";
      }
    }

    // === Core earning actions ===
    async function applyClick(kind) {
      if (!currentUID) return;

      // Ambil snapshot terbaru
      const uSnap = await get(userRef);
      const u = uSnap.val() || {};
      if (u.status === "banned") { el("status").textContent = "Akun diblokir."; return; }

      const now = Date.now();
      const cdKey = kind === "menghasilkan" ? "menghasilkan" : "xstra";
      const dailyKey = cdKey;

      const last = u.cooldowns?.[cdKey] || 0;
      if (now - last < COOLDOWN_MS) {
        el("status").textContent = "Masih cooldown...";
        return;
      }

      // Limit harian
      const currentCount = u.daily?.[dailyKey] || 0;
      const limit = cdKey === "menghasilkan" ? LIMIT_MENG : LIMIT_X;
      if (currentCount >= limit) {
        el("status").textContent = "Sudah mencapai batas harian.";
        return;
      }

      // Simple extra anti-tuyul: block suspicious UA
      if (looksLikeEmulator(u.userAgent || "")) {
        await update(userRef, { status: "banned" });
        el("status").textContent = "Akun terdeteksi tidak valid dan diblokir.";
        return;
      }

      // Transaction-like updates
      const award = cdKey === "menghasilkan" ? AWARD_MENG : AWARD_X;
      await update(userRef, {
        saldo: (u.saldo || 0) + award,
        [`cooldowns/${cdKey}`]: now,
        [`daily/${dailyKey}`]: currentCount + 1
      });

      // Trigger ads depending on button
      if (cdKey === "menghasilkan") {
        showMonetag();
      } else {
        await showClickadillaSequence();
      }

      el("status").textContent = `+${fmtIDR(award)} ditambahkan.`;
    }

    // === Bind buttons ===
    el("btnMeng").addEventListener("click", () => applyClick("menghasilkan"));
    el("btnX").addEventListener("click", () => applyClick("xstra"));

    // === ADS placeholders ===
    function showMonetag() {
      // TODO: tempelkan script Monetag kamu di sini
      // Contoh:
      // const s = document.createElement('script');
      // s.src = 'https://...monetag.js'; document.getElementById('monetag-slot').appendChild(s);
    }

    async function showClickadillaSequence() {
      // 1) In-page
      // TODO: tempelkan script Clickadilla in-page kamu di sini
      // const s = document.createElement('script');
      // s.src = 'https://...clickadilla-inpage.js'; document.getElementById('clickad-inpage').appendChild(s);

      // 2) 4 detik kemudian → popunder
      await new Promise(r => setTimeout(r, 4000));
      // TODO: ganti ke URL/skrip popunder kamu
      // Contoh trigger popunder via redirect di iframe agar tidak mengganggu tab aktif:
      // const frame = document.getElementById('popunder-frame');
      // frame.src = 'https://your-popunder-url.example.com';
    }
  </script>
</body>
</html>
