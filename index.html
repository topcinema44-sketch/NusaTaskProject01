<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NUSA TASK – Bot Earning</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Animasi loading premium */
    #loadingScreen {
      animation: fadeOut 1s ease-in-out forwards;
      animation-delay: 2.5s;
    }
    @keyframes fadeOut {
      to { opacity: 0; visibility: hidden; }
    }
    .logo {
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(to right, #34d399, #3b82f6, #9333ea);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

  <!-- Loading -->
  <div id="loadingScreen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
    <div class="logo">NT</div>
    <div class="mt-6 w-40 bg-gray-700 rounded-full h-2 overflow-hidden">
      <div class="h-2 bg-gradient-to-r from-green-400 via-blue-500 to-purple-500 animate-pulse w-full"></div>
    </div>
    <p class="mt-4 text-gray-400">Loading...</p>
  </div>

  <!-- Auth -->
  <div id="authBox" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg w-96">
    <h1 class="text-2xl font-bold text-center mb-4 text-green-400">NUSA TASK – Login</h1>
    <form id="authForm" class="space-y-4">
      <input id="email" type="email" placeholder="Email" required
        class="w-full p-3 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-400">
      <input id="password" type="password" placeholder="Password" required
        class="w-full p-3 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-400">
      <button type="submit" 
        class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-black font-bold py-2 rounded-lg shadow-lg hover:opacity-90">
        Login / Register
      </button>
    </form>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden w-full max-w-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold">NUSA TASK – Earning</h2>
      <span id="userEmail" class="bg-gray-700 px-3 py-1 rounded-lg text-sm"></span>
    </div>

    <!-- Menghasilkan -->
    <div class="mb-6">
      <button id="earnBtn" class="w-full bg-green-500 text-black font-bold py-3 rounded-xl shadow hover:opacity-80 transition">
        Menghasilkan (Rp 20.000)
      </button>
      <div id="earnBar" class="h-2 bg-gray-700 rounded mt-2 hidden">
        <div class="h-2 bg-green-400 rounded" style="width:0%"></div>
      </div>
      <p id="earnCounter" class="text-sm text-gray-400 mt-1"></p>
    </div>

    <!-- Bonus 1 -->
    <div class="mb-6">
      <button id="bonus1Btn" class="w-full bg-blue-500 text-black font-bold py-3 rounded-xl shadow hover:opacity-80 transition">
        Xstra Bonus 1 (Rp 10.000)
      </button>
      <div id="bonus1Bar" class="h-2 bg-gray-700 rounded mt-2 hidden">
        <div class="h-2 bg-blue-400 rounded" style="width:0%"></div>
      </div>
      <p id="bonus1Counter" class="text-sm text-gray-400 mt-1"></p>
    </div>

    <!-- Bonus 2 -->
    <div class="mb-6">
      <button id="bonus2Btn" class="w-full bg-purple-500 text-black font-bold py-3 rounded-xl shadow hover:opacity-80 transition">
        Xstra Bonus 2 (Rp 10.000)
      </button>
      <div id="bonus2Bar" class="h-2 bg-gray-700 rounded mt-2 hidden">
        <div class="h-2 bg-purple-400 rounded" style="width:0%"></div>
      </div>
      <p id="bonus2Counter" class="text-sm text-gray-400 mt-1"></p>
    </div>

    <p id="statusMsg" class="mt-6 text-center text-sm text-gray-400"></p>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } 
      from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue } 
      from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyBpKWInCFVA_4-qyCT4QvW86e1uVf5YtEA",
      authDomain: "nusataskproject-872a1.firebaseapp.com",
      databaseURL: "https://nusataskproject-872a1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nusataskproject-872a1",
      storageBucket: "nusataskproject-872a1.firebasestorage.app",
      messagingSenderId: "669134125045",
      appId: "1:669134125045:web:840b60f2f987aba8fcd2bc",
      measurementId: "G-MX4259KDTG"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Cooldown (ms)
    const COOLDOWN = 180000;

    // Progress bar
    function startProgress(barId, duration) {
      const bar = document.querySelector(`#${barId} div`);
      const wrapper = document.getElementById(barId);
      wrapper.classList.remove("hidden");
      let start = Date.now();
      let interval = setInterval(() => {
        let percent = Math.min(((Date.now() - start) / duration) * 100, 100);
        bar.style.width = percent + "%";
        if (percent >= 100) {
          clearInterval(interval);
          wrapper.classList.add("hidden");
          bar.style.width = "0%";
        }
      }, 1000);
    }

    // Anti tuyul
    async function checkAntiTuyul(uid) {
      const deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
      localStorage.setItem("deviceId", deviceId);

      let ip = "unknown";
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        ip = (await res.json()).ip;
      } catch {}

      const snap = await get(ref(db, "users/" + uid));
      if (snap.exists()) {
        const data = snap.val();
        if (data.deviceId && data.deviceId !== deviceId) {
          await update(ref(db, "users/" + uid), { banned: true });
          throw new Error("Banned: Multi device");
        }
        if (data.ip && data.ip !== ip) {
          await update(ref(db, "users/" + uid), { banned: true });
          throw new Error("Banned: Multi IP");
        }
      }
      await update(ref(db, "users/" + uid), { deviceId, ip });
    }

    // Auth
    document.getElementById("authForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        await initUser(userCred.user.uid, email);
      } catch {
        try {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          await initUser(userCred.user.uid, email, true);
        } catch (err) {
          Swal.fire("Error", err.message, "error");
        }
      }
    });

    // Init user
    async function initUser(uid, email, isNew=false) {
      if (isNew) {
        await set(ref(db, "users/" + uid), {
          email, balance: 0,
          earnToday: 0, bonus1Today: 0, bonus2Today: 0,
          lastEarn: 0, lastBonus1: 0, lastBonus2: 0,
          lastReset: new Date().toDateString(),
          banned: false
        });
      }
      await checkAntiTuyul(uid);

      document.getElementById("authBox").classList.remove("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("userEmail").innerText = email;

      onValue(ref(db, "users/" + uid), (snap) => {
        if (snap.exists()) updateUI(snap.val());
      });
    }

    // Update UI realtime
    function updateUI(data) {
      if (data.banned) {
        document.getElementById("statusMsg").innerText = "❌ Akun Anda dibanned";
        return;
      }
      document.getElementById("statusMsg").innerText = `Saldo Anda: Rp ${data.balance.toLocaleString()}`;
      document.getElementById("earnCounter").innerText = `${data.earnToday}/20 kali hari ini`;
      document.getElementById("bonus1Counter").innerText = `${data.bonus1Today}/10 kali hari ini`;
      document.getElementById("bonus2Counter").innerText = `${data.bonus2Today}/10 kali hari ini`;
    }

    // Reset harian jam 00:00
    function scheduleReset(uid) {
      const now = new Date();
      const msToMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).getTime() - now.getTime();
      setTimeout(async () => {
        await update(ref(db, "users/" + uid), {
          earnToday: 0, bonus1Today: 0, bonus2Today: 0,
          lastReset: new Date().toDateString()
        });
        scheduleReset(uid);
      }, msToMidnight);
    }

    // Claim reward
    async function claim(uid, type) {
      const snap = await get(ref(db, "users/" + uid));
      if (!snap.exists()) return;
      let data = snap.val();

      if (data.banned) return Swal.fire("Akun Banned", "Anda tidak bisa earning.", "error");

      const today = new Date().toDateString();
      if (data.lastReset !== today) {
        data.earnToday = 0; data.bonus1Today = 0; data.bonus2Today = 0;
        data.lastReset = today;
      }

      let now = Date.now();

      if (type === "earn") {
        if (data.earnToday >= 20) return Swal.fire("Limit", "20x/hari sudah tercapai", "warning");
        if (now - data.lastEarn < COOLDOWN) return Swal.fire("Cooldown", "Tunggu 3 menit lagi", "info");
        data.balance += 20000; data.earnToday++; data.lastEarn = now;
        startProgress("earnBar", COOLDOWN);
      }

      if (type === "bonus1") {
        if (data.bonus1Today >= 10) return Swal.fire("Limit", "Bonus1 sudah 10x/hari", "warning");
        if (now - data.lastBonus1 < COOLDOWN) return Swal.fire("Cooldown", "Tunggu 3 menit lagi", "info");
        data.balance += 10000; data.bonus1Today++; data.lastBonus1 = now;
        startProgress("bonus1Bar", COOLDOWN);
      }

      if (type === "bonus2") {
        if (data.bonus2Today >= 10) return Swal.fire("Limit", "Bonus2 sudah 10x/hari", "warning");
        if (now - data.lastBonus2 < COOLDOWN) return Swal.fire("Cooldown", "Tunggu 3 menit lagi", "info");
        data.balance += 10000; data.bonus2Today++; data.lastBonus2 = now;
        startProgress("bonus2Bar", COOLDOWN);
      }

      await update(ref(db, "users/" + uid), data);
    }

    // Tombol
    document.getElementById("earnBtn").addEventListener("click", () => claim(auth.currentUser.uid, "earn"));
    document.getElementById("bonus1Btn").addEventListener("click", () => claim(auth.currentUser.uid, "bonus1"));
    document.getElementById("bonus2Btn").addEventListener("click", () => claim(auth.currentUser.uid, "bonus2"));

    // Hilangin loading setelah 3s
    setTimeout(() => {
      document.getElementById("loadingScreen").style.display = "none";
      document.getElementById("authBox").classList.remove("hidden");
    }, 3000);
  </script>
</body>
</html>