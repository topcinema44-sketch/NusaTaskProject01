<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NusaTask â€” Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0b0f14; --bg2:#0f1724; --card:#0f1720;
    --muted:#97a6b2; --accent1:#7c5cff; --accent2:#00d0ff;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef6}
  .wrap{max-width:820px;margin:28px auto;padding:20px;}
  .header{display:flex;align-items:center;gap:16px;justify-content:center;margin-bottom:18px}
  .logo-circle{width:84px;height:84px;border-radius:22px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 10px 30px rgba(124,92,255,0.12), inset 0 -6px 18px rgba(0,0,0,0.25)}
  .brand{font-weight:800;font-size:28px;letter-spacing:0.6px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter:blur(8px);border-radius:16px;padding:22px;margin:12px auto;box-shadow:0 12px 40px rgba(2,6,23,0.6)}
  .muted{color:var(--muted);font-size:13px}
  .field{margin-top:12px}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:12px 16px;border-radius:12px;color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.5);transition:transform .12s,opacity .12s}
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  .row{display:flex;gap:12px}
  .center{display:flex;flex-direction:column;align-items:center;gap:10px}
  .progress-wrap{height:12px;background:rgba(255,255,255,0.03);border-radius:10px;overflow:hidden;margin-top:12px}
  .progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .35s ease}
  .small{font-size:13px;color:var(--muted)}
  .warning-overlay{position:fixed;inset:0;background:linear-gradient(rgba(3,6,12,0.7),rgba(2,4,8,0.85));display:none;align-items:center;justify-content:center;z-index:9999}
  .warning-box{background:linear-gradient(180deg,#071018,#0e1b24);padding:24px;border-radius:14px;width:min(520px,92%);text-align:center;color:#dbeafe}
  .disabled{opacity:0.45;pointer-events:none}
  .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#071018,#081425);z-index:10000}
  .spinner{width:72px;height:72px;border-radius:50%;border:6px solid rgba(255,255,255,0.06);border-top-color:var(--accent1);animation:spin 1s linear infinite;box-shadow:0 8px 30px rgba(124,92,255,0.12)}
  @keyframes spin{to{transform:rotate(360deg)}}
  .banned-box{background:#0b0710;border-radius:12px;padding:20px;}
  /* responsive */
  @media (max-width:520px){ .header{flex-direction:column;gap:10px} .brand{font-size:22px} .card{padding:18px} }
</style>
</head>
<body>
  <!-- splash / loading -->
  <div id="splash" class="splash" style="display:flex">
    <div style="text-align:center">
      <div class="spinner" aria-hidden="true"></div>
      <div style="height:12px"></div>
      <div class="small" style="color:#9fbbe8">Memuat NusaTaskâ€¦</div>
    </div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="logo-circle"><div style="font-weight:800;font-size:20px;color:white">NT</div></div>
      <div style="text-align:center">
        <div class="brand">NusaTask</div>
        <div class="muted small">Premium â€¢ Secure â€¢ Dark UI</div>
      </div>
    </div>

    <!-- AUTH CARD -->
    <div id="authCard" class="card" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:18px">Masuk / Daftar</div>
          <div class="small muted">Gunakan email yang valid</div>
        </div>
        <div id="saldobadge" style="background:var(--glass);padding:10px;border-radius:10px;font-weight:700">Saldo: <span id="saldoSimple">0</span></div>
      </div>

      <div class="field">
        <input id="email" type="email" placeholder="Email">
      </div>
      <div class="field">
        <input id="password" type="password" placeholder="Password (min 6)">
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="btnLogin" class="btn" style="flex:1">Login</button>
        <button id="btnRegister" class="btn ghost" style="flex:1">Register</button>
      </div>

      <div style="height:12px"></div>
      <div class="small muted" id="authNote">Dengan mendaftar, segala bentuk hack/nuyul akan dibanned otomatis.</div>
    </div>

    <!-- MAIN APP Card -->
    <div id="appCard" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:18px">Dashboard</div>
          <div class="small muted">Tekan untuk menghasilkan. Cooldown 3 menit.</div>
        </div>
        <div style="text-align:right">
          <div class="muted small">Reset harian: 06:00 server</div>
        </div>
      </div>

      <div style="margin-top:16px;text-align:center">
        <div style="width:96px;height:96px;border-radius:18px;margin:auto;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:800">NT</div>
        <div style="height:12px"></div>
        <div style="font-weight:800;font-size:20px">NusaTask</div>
        <div class="muted small" style="margin-top:6px">Saldo: <span id="saldo">0</span></div>
      </div>

      <div style="margin-top:18px">
        <div style="display:flex;flex-direction:column;gap:14px">
          <div>
            <button id="earnBtn" class="btn" style="width:100%">ðŸŽ¯ Menghasilkan (Earn +1)</button>
            <div class="progress-wrap" style="margin-top:10px">
              <div id="earnProgress" class="progress"></div>
            </div>
            <div class="small muted" style="margin-top:8px">Terpakai hari ini: <span id="earnUsed">0</span>/<span id="earnMax">25</span></div>
          </div>

          <div>
            <button id="bonusBtn" class="btn" style="width:100%">ðŸ’Ž Xstra Bonus (+30)</button>
            <div class="progress-wrap" style="margin-top:10px">
              <div id="bonusProgress" class="progress"></div>
            </div>
            <div class="small muted" style="margin-top:8px">Terpakai hari ini: <span id="bonusUsed">0</span>/<span id="bonusMax">25</span></div>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>
      <div class="small muted">Jika dibanned, hubungi admin: <a href="https://t.me/nusataskproject" target="_blank" style="color:var(--accent1)">t.me/nusataskproject</a></div>
    </div>
  </div>

  <!-- Warning overlay after register -->
  <div id="warningOverlay" class="warning-overlay" role="dialog" aria-modal="true">
    <div class="warning-box">
      <div style="font-weight:800;font-size:18px;margin-bottom:8px">Peringatan Penting</div>
      <div class="muted small" style="margin-bottom:12px">
        Segala bentuk hack, nuyul, multi-akun dari 1 device / 1 IP akan menyebabkan pembatasan / pembanan otomatis.
      </div>
      <div style="margin-bottom:12px">
        Tombol <strong>LANJUTKAN</strong> akan aktif setelah <span id="countdown">5</span> detik.
      </div>
      <div style="display:flex;gap:12px;justify-content:center">
        <button id="btnContinue" class="btn disabled" aria-disabled="true">LANJUTKAN</button>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= CONFIG ================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAUcac_uXdofDbqPwltgb4m7qIPiQhJi0s",
  authDomain: "nusataskproject.firebaseapp.com",
  databaseURL: "https://nusataskproject-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nusataskproject",
  storageBucket: "nusataskproject.firebasestorage.app",
  messagingSenderId: "409602188456",
  appId: "1:409602188456:web:6302d3030b763324e28e9d",
  measurementId: "G-9389QL1WRE"
};
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.database();

/* ================= CONSTANTS ================= */
const COOLDOWN = 3 * 60 * 1000; // 3 menit
const EARN_MAX = 25;
const BONUS_MAX = 25;

/* ================= UI refs ================= */
const splash = document.getElementById('splash');
const authCard = document.getElementById('authCard');
const appCard = document.getElementById('appCard');
const saldoSpan = document.getElementById('saldo');
const saldoSimple = document.getElementById('saldoSimple');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');
const earnBtn = document.getElementById('earnBtn');
const bonusBtn = document.getElementById('bonusBtn');
const earnProgress = document.getElementById('earnProgress');
const bonusProgress = document.getElementById('bonusProgress');
const earnUsedEl = document.getElementById('earnUsed');
const bonusUsedEl = document.getElementById('bonusUsed');
const earnMaxEl = document.getElementById('earnMax');
const bonusMaxEl = document.getElementById('bonusMax');

/* ================= DEVICE ID & SERVER TIME ================= */
function getDeviceId(){
  let id = localStorage.getItem('nusatask_device');
  if(!id){ id = 'dev-' + Math.random().toString(36).slice(2,12); localStorage.setItem('nusatask_device', id); }
  return id;
}
const deviceId = getDeviceId();

// helper to get approximate server time using .info/serverTimeOffset
async function getServerTime(){
  const snap = await db.ref(".info/serverTimeOffset").once("value");
  const offset = snap.val() || 0;
  return Date.now() + offset;
}

/* ================= AUTH UI ================= */
btnRegister.addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if(!email || pass.length < 6){ alert('Isi email & password minimal 6 karakter'); return; }
  try{
    // create user
    showSplash(true, 'Mendaftarkan akunâ€¦');
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    // after successful register, show warning overlay then continue
    showWarningThenContinue(cred.user.uid);
  }catch(e){
    alert(e.message);
  }finally{ showSplash(false); }
});

btnLogin.addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if(!email || pass.length < 6){ alert('Isi email & password minimal 6 karakter'); return; }
  try{
    showSplash(true, 'Masukâ€¦');
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){ alert(e.message); }
  finally{ showSplash(false); }
});

/* ================= Warning overlay logic (register) ================= */
function showWarningThenContinue(uid){
  const overlay = document.getElementById('warningOverlay');
  const btn = document.getElementById('btnContinue');
  const cdEl = document.getElementById('countdown');
  overlay.style.display = 'flex';
  let t = 5;
  cdEl.innerText = t;
  btn.classList.add('disabled'); btn.setAttribute('aria-disabled','true');

  const timer = setInterval(()=>{
    t-=1; cdEl.innerText = t;
    if(t<=0){
      clearInterval(timer);
      btn.classList.remove('disabled'); btn.removeAttribute('aria-disabled');
      btn.addEventListener('click', async function onContinue(){
        btn.removeEventListener('click', onContinue);
        overlay.style.display = 'none';
        // continue initialization (auto-login already happened by firebase auth state)
      });
    }
  },1000);
}

/* ================= Splash helper ================= */
function showSplash(show, text=''){
  splash.style.display = show ? 'flex' : 'none';
  // text optional (we keep spinner only)
}

/* ================= database rules rely on these paths:
   - users/{uid}
   - devices/{deviceId}
   - iplog/{ip}/{uid}
   Rules must forbid direct writes to balance, banned, next* fields (see provided rules).
*/

/* ================= AUTH state handling ================= */
let userRef = null;

auth.onAuthStateChanged(async user=>{
  if(user){
    // hide auth, show app
    authCard.style.display = 'none';
    appCard.style.display = 'block';
    // compute server time
    const serverNow = await getServerTime();

    // setup userRef and check registration + anti-tuyul
    userRef = db.ref('users/' + user.uid);

    // get client ip
    let ip = 'unknown';
    try{
      const r = await fetch('https://api.ipify.org?format=json'); ip = (await r.json()).ip || 'unknown';
    }catch(e){ ip = 'unknown'; }

    // critical: atomic check/create: we cannot run multi-document transaction in RTDB,
    // but we perform sequential checks and write user data carefully.
    userRef.once('value').then(async snap=>{
      if(!snap.exists()){
        // new user -> perform anti-tuyul checks
        // 1) device check
        const devSnap = await db.ref('devices/' + deviceId).once('value');
        if(devSnap.exists()){
          const mappedUid = devSnap.val().uid;
          if(mappedUid && mappedUid !== user.uid){
            // device already bound to other uid => ban this new account
            await userRef.set({ banned: true, createdAt: serverNow });
            alert('Registrasi ditolak: device ini sudah terdaftar akun lain. Akun dibanned.');
            return;
          }
        }

        // 2) ip check
        const ipRefRoot = db.ref('iplog/' + ip);
        const ipSnap = await ipRefRoot.once('value');
        if(ipSnap.exists()){
          // if there exists a different uid on same IP and its deviceId differs from this device => ban
          const entries = ipSnap.val();
          const keys = Object.keys(entries);
          // if existing keys length >=1, we consider IP already used; enforce strict 1 akun per IP
          // but allow if same deviceId exists in users (user switching wifi) -> handled below
          let multipleDifferent = false;
          for(let k of keys){
            if(k !== user.uid){
              multipleDifferent = true; break;
            }
          }
          if(multipleDifferent){
            // check whether all existing users share same deviceId as current device - if not, ban
            let conflict = false;
            for(let k of keys){
              if(k === user.uid) continue;
              const other = await db.ref('users/' + k + '/deviceId').once('value');
              if(other.exists() && other.val() !== deviceId){ conflict = true; break; }
            }
            if(conflict){
              await userRef.set({ banned: true, createdAt: serverNow });
              alert('Registrasi ditolak: IP ini sudah dipakai akun lain. Akun dibanned.');
              return;
            }
          }
        }

        // pass checks -> bind device and ip and create user
        await db.ref('devices/' + deviceId).set({ uid: user.uid, createdAt: serverNow });
        await db.ref('iplog/' + ip + '/' + user.uid).set({ ts: serverNow });
        await userRef.set({
          email: user.email || null,
          balance: 0,
          banned: false,
          deviceId: deviceId,
          ip: ip,
          earnUsedToday: 0,
          bonusUsedToday: 0,
          nextEarnAt: 0,
          nextBonusAt: 0,
          lastResetAt: serverNow,
          createdAt: serverNow
        });
      } else {
        // existing user: update ip if changed, and ensure device mapping exists
        const data = snap.val();
        // if this device is mapped to other uid and it's not this => ban
        const devSnap2 = await db.ref('devices/' + deviceId).once('value');
        if(devSnap2.exists() && devSnap2.val().uid !== user.uid){
          // device already mapped to another UID -> ban this user
          await userRef.update({ banned: true });
          alert('Device conflict detected, akun dibanned.');
          return;
        } else {
          // ensure mapping present
          await db.ref('devices/' + deviceId).set({ uid: user.uid, createdAt: data.createdAt || serverNow });
        }

        // update iplog if ip changed
        if(data.ip !== ip){
          await db.ref('iplog/' + ip + '/' + user.uid).set({ ts: serverNow });
          await userRef.update({ ip: ip });
        }
      }
      // after create/check, start listening to user changes
      startUserListener(user.uid);
    }).catch(e=>{
      console.error('error checking user:', e);
    });
  } else {
    // no user -> show auth
    authCard.style.display = 'block';
    appCard.style.display = 'none';
    if(userRef) userRef.off();
  }
});

/* ================= start listening to user doc for UI updates ================= */
function startUserListener(uid){
  userRef = db.ref('users/' + uid);
  // remove splash
  splash.style.display = 'none';

  userRef.on('value', async snap=>{
    const data = snap.val();
    if(!data) return;
    // banned?
    if(data.banned){
      showBanned();
      return;
    }
    // reset daily if needed (server time)
    const serverNow = await getServerTime();
    let updated = false;
    const lastReset = data.lastResetAt || 0;
    const resetToday = (() => {
      const d = new Date(serverNow);
      d.setHours(6,0,0,0);
      if(serverNow < d.getTime()){
        d.setDate(d.getDate()-1);
      }
      return d.getTime();
    })();
    if(!lastReset || lastReset < resetToday){
      // reset counts (perform update)
      await userRef.update({ earnUsedToday: 0, bonusUsedToday: 0, lastResetAt: serverNow });
      data.earnUsedToday = 0; data.bonusUsedToday = 0; updated = true;
    }

    // update UI fields
    const bal = data.balance || 0;
    saldoSpan.innerText = bal;
    saldoSimple.innerText = bal;
    earnUsedEl.innerText = data.earnUsedToday || 0;
    bonusUsedEl.innerText = data.bonusUsedToday || 0;
    earnMaxEl.innerText = EARN_MAX;
    bonusMaxEl.innerText = BONUS_MAX;

    // progress bars reflect usage (0..max)
    const eUsed = Math.min(EARN_MAX, data.earnUsedToday || 0);
    const bUsed = Math.min(BONUS_MAX, data.bonusUsedToday || 0);
    earnProgress.style.width = (eUsed / EARN_MAX * 100) + '%';
    bonusProgress.style.width = (bUsed / BONUS_MAX * 100) + '%';

    // cooldown logic: compute server time and compare with nextEarnAt/nextBonusAt
    const serverNow2 = await getServerTime();
    const nextEarnAt = data.nextEarnAt || 0;
    const nextBonusAt = data.nextBonusAt || 0;
    earnBtn.disabled = serverNow2 < nextEarnAt;
    bonusBtn.disabled = serverNow2 < nextBonusAt;

    // reflect disabled visual
    earnBtn.style.opacity = earnBtn.disabled ? 0.6 : 1;
    bonusBtn.style.opacity = bonusBtn.disabled ? 0.6 : 1;
  });
}

/* ================= show banned overlay ================= */
function showBanned(){
  const node = document.createElement('div');
  node.style.position='fixed'; node.style.inset='0'; node.style.background='rgba(0,0,0,0.96)';
  node.style.zIndex='99999'; node.style.display='grid'; node.style.placeItems='center';
  node.innerHTML = `<div class="banned-box"><div style="font-weight:800;color:#ff6b6b;font-size:20px;margin-bottom:8px">ðŸš« Akun DIBANNED</div>
    <div class="muted small" style="margin-bottom:10px">Jika Anda merasa ini kesalahan, hubungi admin:</div>
    <div style="text-align:center"><a href="https://t.me/nusataskproject" target="_blank" style="color:var(--accent1);font-weight:700">t.me/nusataskproject</a></div></div>`;
  document.body.appendChild(node);
}

/* ================= ACTIONS (earn / bonus) menggunakan transaction dan serverTime ================= */
earnBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user) return;
  const serverNow = await getServerTime();
  const ref = db.ref('users/' + user.uid);
  ref.transaction(data=>{
    if(!data) return data;
    // server-side reset already handled; but just check here
    const nextEarnAt = data.nextEarnAt || 0;
    if(serverNow < nextEarnAt) { alert('Masih cooldown'); return; }
    if((data.earnUsedToday || 0) >= EARN_MAX){ alert('Limit harian tercapai'); return; }
    // apply changes
    data.balance = (data.balance || 0) + 1;
    data.earnUsedToday = (data.earnUsedToday || 0) + 1;
    data.nextEarnAt = serverNow + COOLDOWN;
    data.lastActionAt = serverNow;
    return data;
  }, function(error, committed, snapshot){
    if(error){ console.error('Trans error', error); alert('Gagal, coba lagi'); }
    else if(!committed){ /* no-op if prevented by checks in transaction callback */ }
    else { barAnimate(earnProgress); }
  }, false);
});

bonusBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user) return;
  const serverNow = await getServerTime();
  const ref = db.ref('users/' + user.uid);
  ref.transaction(data=>{
    if(!data) return data;
    const nextBonusAt = data.nextBonusAt || 0;
    if(serverNow < nextBonusAt) { alert('Masih cooldown'); return; }
    if((data.bonusUsedToday || 0) >= BONUS_MAX){ alert('Limit harian tercapai'); return; }
    data.balance = (data.balance || 0) + 30;
    data.bonusUsedToday = (data.bonusUsedToday || 0) + 1;
    data.nextBonusAt = serverNow + COOLDOWN;
    data.lastActionAt = serverNow;
    return data;
  }, function(error, committed, snapshot){
    if(error){ console.error('Trans error', error); alert('Gagal, coba lagi'); }
    else if(!committed){ }
    else { barAnimate(bonusProgress); }
  }, false);
});

/* simple bar animate for click feedback */
function barAnimate(el){
  el.style.transition = 'width .4s linear';
  const prev = el.style.width;
  el.style.width = '100%';
  setTimeout(()=>{ el.style.width = prev; }, 600);
}

/* hide splash after initial load (safety) */
window.addEventListener('load', ()=> setTimeout(()=>{ splash.style.display='none'; }, 600) );

/* remove logout: auto-login persists, no logout button */
</script>
</body>
</html>