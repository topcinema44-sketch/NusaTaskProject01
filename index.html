<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NusaTask - Earning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0e1220; font-family: 'Poppins', sans-serif; color: white; }
    .card { max-width: 420px; margin: 20px auto; padding: 20px; border-radius: 20px; background: #151b2b; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .saldo-box { background: linear-gradient(135deg, #8e2de2, #4a00e0); border-radius: 15px; text-align: center; padding: 30px 20px; margin-bottom: 20px; }
    .saldo-box h2 { font-size: 1rem; font-weight: 400; }
    .saldo-box h1 { font-size: 2rem; margin-top: 5px; font-weight: 600; }
    .section-title { font-size: 1.1rem; margin: 10px 0; font-weight: 600; }
    .btn { display: block; width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform .2s ease, opacity .2s ease; }
    .btn:hover { transform: scale(1.03); opacity: .9; }
    .btn-green { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
    .btn-disabled { background: #555 !important; cursor: not-allowed; }

    /* üîî Notif Overlay */
    #notifOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); z-index: 9999;
    }
    #notifCard {
      background: #151b2b; padding: 20px; border-radius: 15px;
      text-align: center; max-width: 320px; width: 90%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      animation: fadeInUp 0.4s ease;
    }
    #notifCard h2 { font-size: 1.2rem; margin-bottom: 10px; font-weight: 600; }
    #notifCard p { font-size: .9rem; opacity: .9; }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>

  <div class="card">
    <!-- Form Login / Register -->
    <div id="authBox">
      <h2 class="text-lg font-bold mb-2">Login / Register</h2>
      <input id="email" type="email" placeholder="Email" class="w-full p-2 mb-2 rounded text-black">
      <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 rounded text-black">
      <button id="btnRegister" class="btn btn-green">Register + Login</button>
      <button id="btnLogin" class="btn btn-green">Login</button>
    </div>

    <!-- Main Content -->
    <div id="mainBox" style="display:none;">
      <div class="saldo-box">
        <h2>Saldo Anda</h2>
        <h1 id="saldo">Rp0</h1>
      </div>

      <div class="section-title">Tugas Harian</div>
      <button id="btnTask1" class="btn btn-green">Kerjakan Tugas 1</button>
      <button id="btnLogout" class="btn btn-green">Logout</button>
    </div>
  </div>

  <!-- Notif -->
  <div id="notifOverlay">
    <div id="notifCard">
      <h2 id="notifTitle">Notif</h2>
      <p id="notifMsg">Pesan disini</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, get, set } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // üîπ Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDdlvPMWThdEUk2D92Tg_mQSHbGO4LG2AE",
      authDomain: "nusa-7a52a.firebaseapp.com",
      projectId: "nusa-7a52a",
      storageBucket: "nusa-7a52a.firebasestorage.app",
      messagingSenderId: "72016839114",
      appId: "1:72016839114:web:0bc8978a826619f7ad8f33",
      measurementId: "G-HBZN4WGKWX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // üîî Notif Function
    function showNotif(type, title, msg, sticky=false) {
      const overlay = document.getElementById("notifOverlay");
      const titleEl = document.getElementById("notifTitle");
      const msgEl = document.getElementById("notifMsg");

      let color = "#38ef7d"; // green
      if (type === "error") color = "#ff4444";
      if (type === "warn") color = "#ffbb33";
      if (type === "ban") color = "#ff4444";

      titleEl.innerText = title;
      msgEl.innerText = msg;
      titleEl.style.color = color;

      overlay.style.display = "flex";
      if (!sticky) setTimeout(() => { overlay.style.display = "none"; }, 3000);
    }

    // üîí Overlay banned
    function showBanned() {
      showNotif("ban", "Akun Diblokir", "‚ùå Akun anda dibanned. Hubungi admin: t.me/nusataskproject", true);
      document.getElementById("mainBox").innerHTML = "";
    }

    // üîπ Ambil IP Publik
    async function getUserIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch { return "0.0.0.0"; }
    }

    // üîπ Anti Tuyul Security
    async function checkSecurity(uid) {
      const ip = await getUserIP();
      const deviceId = uid + navigator.userAgent + screen.width + "x" + screen.height;
      const today = new Date().toISOString().split("T")[0];
      const secRef = ref(db, "users/" + uid + "/security");

      const snap = await get(secRef);
      let secData = snap.exists() ? snap.val() : { ipHistory: {} };

      if (secData.banned) { showBanned(); return false; }

      let ips = secData.ipHistory[today] || [];
      if (!ips.includes(ip)) {
        if (ips.length >= 2) {
          await set(secRef, { ...secData, banned: true });
          showBanned();
          return false;
        }
        ips.push(ip);
      }

      const allUsersRef = ref(db, "users");
      const allUsersSnap = await get(allUsersRef);
      if (allUsersSnap.exists()) {
        const users = allUsersSnap.val();
        for (let otherId in users) {
          if (otherId !== uid && users[otherId].security?.ipHistory?.[today]?.includes(ip)) {
            await set(secRef, { ...secData, banned: true });
            showBanned();
            return false;
          }
        }
      }

      secData.deviceId = deviceId;
      secData.ipHistory[today] = ips;
      await set(secRef, secData);
      return true;
    }

    // üîπ Register
    document.getElementById("btnRegister").addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      createUserWithEmailAndPassword(auth, email, pass)
        .then(() => showNotif("success", "Registrasi", "‚úÖ Akun berhasil dibuat & login"))
        .catch(err => showNotif("error", "Error", err.message));
    });

    // üîπ Login
    document.getElementById("btnLogin").addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, pass)
        .catch(err => showNotif("error", "Login Gagal", err.message));
    });

    // üîπ Logout
    document.getElementById("btnLogout").addEventListener("click", () => {
      signOut(auth).then(() => {
        location.reload();
      });
    });

    // üîπ Listener Auth
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const uid = user.uid;
        const safe = await checkSecurity(uid);
        if (!safe) return;

        document.getElementById("authBox").style.display = "none";
        document.getElementById("mainBox").style.display = "block";

        const saldoRef = ref(db, "users/" + uid + "/saldo");
        const dailyRef = ref(db, "daily/" + uid);

        onValue(saldoRef, (snap) => {
          const saldo = snap.exists() ? snap.val() : 0;
          document.getElementById("saldo").innerText = "Rp" + saldo.toLocaleString("id-ID");
        });

        // üîπ Tombol Tugas 1
        const el = document.getElementById("btnTask1");
        el.addEventListener("click", async () => {
          const dailySnap = await get(dailyRef);
          const dailyData = dailySnap.exists() ? dailySnap.val() : {};
          const count = dailyData["btnTask1"]?.count || 0;
          const last = dailyData["btnTask1"]?.last || 0;
          const now = Date.now();

          if (count >= 20) { showNotif("warn", "Limit Harian", "‚ùå Sudah 20x klik hari ini"); return; }
          if (now - last < 120000) { showNotif("warn", "Cooldown", "‚è≥ Tunggu 2 menit sebelum klik lagi"); return; }

          const ip = await getUserIP();
          runTransaction(saldoRef, (saldo) => (saldo || 0) + 500);
          set(ref(db, `daily/${uid}/btnTask1`), { count: count + 1, last: now });

          // üîπ Log aktivitas
          const today = new Date().toISOString().split("T")[0];
          const logRef = ref(db, `logs/${uid}/${today}/${Date.now()}`);
          set(logRef, { task: "btnTask1", reward: 500, ip: ip, time: new Date().toISOString() });

          showNotif("success", "Berhasil", "‚úÖ +Rp500 ditambahkan ke saldo");
          startCooldown(el, 120);
        });

        function startCooldown(button, seconds) {
          button.disabled = true;
          button.classList.add("btn-disabled");
          let remaining = seconds;
          const original = button.innerText;
          const interval = setInterval(() => {
            button.innerText = `Cooldown ${remaining}s`;
            remaining--;
            if (remaining < 0) {
              clearInterval(interval);
              button.disabled = false;
              button.classList.remove("btn-disabled");
              button.innerText = original;
            }
          }, 1000);
        }

        // üîπ Reset Daily 03:00 WIB
        function checkResetDaily() {
          const now = new Date();
          const resetTime = new Date();
          resetTime.setHours(3, 0, 0, 0);
          if (now > resetTime) resetTime.setDate(resetTime.getDate() + 1);
          const msUntilReset = resetTime - now;
          setTimeout(() => { set(dailyRef, {}); checkResetDaily(); }, msUntilReset);
        }
        checkResetDaily();
      }
    });
  </script>
</body>
</html>