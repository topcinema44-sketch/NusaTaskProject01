<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NUSA TASK — Final (Super Premium)</title>

  <!-- Fonts & SweetAlert2 -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#05060a; --card:#0e1620; --muted:#98a1a8; --accent1:#00ffd0; --accent2:#2b7cff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Roboto,Arial;color:#e6eef1;background:linear-gradient(180deg,#03040a,#07101a)}
    .center{display:flex;align-items:center;justify-content:center}
    /* Loading */
    #loading{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;background:linear-gradient(180deg,rgba(2,6,11,0.85),rgba(2,6,11,0.95))}
    .logo{font-size:64px;font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:logoPulse 2.4s ease-in-out infinite}
    @keyframes logoPulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.06);opacity:.9}100%{transform:scale(1);opacity:1}}
    .loading-track{width:320px;height:10px;border-radius:999px;background:rgba(255,255,255,0.04);overflow:hidden}
    .loading-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width 0.2s linear}

    /* App */
    .wrap{max-width:820px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{font-weight:700}
    .profile{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#071826,#0b2b35);display:flex;align-items:center;justify-content:center;font-weight:800;color:#cfeee7}
    .email{font-size:13px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px;max-width:720px;margin-left:auto;margin-right:auto}
    .card{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(2,6,14,0.6)}
    .title{font-weight:700;color:var(--accent1)}
    .small{font-size:13px;color:var(--muted)}
    .saldo{font-weight:800;font-size:18px}

    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
    .btn-large{width:100%;padding:14px;border-radius:12px;font-size:15px}
    .btn-earn{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#021018}
    .btn-xtra1{background:linear-gradient(135deg,#6ee7b7,#60a5fa);color:#021018}
    .btn-xtra2{background:linear-gradient(135deg,#f9a8d4,#a78bfa);color:#021018}
    .disabled{background:#4b5563!important;color:#cfcfcf!important;cursor:not-allowed!important;opacity:.85!important}

    .progress-wrap{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:8px}
    .progress-bar{height:100%;width:0%;transition:width .5s ease;border-radius:999px}

    .counter{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}

    /* Banned overlay */
    #bannedOverlay{position:fixed;inset:0;background:rgba(2,6,11,0.92);display:none;z-index:10000;align-items:center;justify-content:center;color:#fff;flex-direction:column;gap:12px}
    #bannedOverlay .msg{max-width:440px;text-align:center}

    /* Admin panel */
    #adminPanel{display:none;position:fixed;right:18px;bottom:18px;width:360px;z-index:30}
    @media(min-width:820px){ .grid{grid-template-columns:1fr 320px} }
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loading">
    <div class="logo">NT</div>
    <div class="loading-track"><div id="loadingBar" class="loading-bar"></div></div>
    <div class="small">Menyiapkan NUSA TASK…</div>
  </div>

  <!-- Banned Overlay -->
  <div id="bannedOverlay" class="center">
    <div class="msg">
      <h2 style="color:#ff6b6b;margin:0">Akun Diblokir</h2>
      <p class="small" style="margin-top:8px">Akun Anda telah dibanned otomatis karena terdeteksi aktivitas yang melanggar aturan. Hubungi admin jika ingin dibuka.</p>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <header>
      <div>
        <div class="brand">NUSA TASK</div>
        <div class="small">Bot Earning — Super Premium</div>
      </div>

      <div class="profile">
        <div class="avatar" id="avatar">NT</div>
        <div style="text-align:right">
          <div id="emailDisplay" class="email">—</div>
          <div id="saldoDisplay" class="saldo">Rp 0</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Left: earning controls -->
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="title">Earning</div>
              <div class="small">Tekan tombol untuk klaim reward (setiap klaim membuka iklan, lalu kredit).</div>
            </div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <!-- Earn -->
          <div style="margin-bottom:14px">
            <button id="btnEarn" class="btn btn-large btn-earn">Menghasilkan (Rp 20.000)</button>
            <div class="progress-wrap"><div id="progressEarn" class="progress-bar" style="background:linear-gradient(90deg,#00ffd0,#2b7cff)"></div></div>
            <div class="counter" id="counterEarn">0 / 20 hari ini</div>
          </div>

          <!-- Bonus 1 -->
          <div style="margin-bottom:14px">
            <button id="btnX1" class="btn btn-large btn-xtra1">Xstra Bonus 1 (Rp 10.000)</button>
            <div class="progress-wrap"><div id="progressX1" class="progress-bar" style="background:linear-gradient(90deg,#60a5fa,#34d399)"></div></div>
            <div class="counter" id="counterX1">0 / 10 hari ini</div>
          </div>

          <!-- Bonus 2 -->
          <div style="margin-bottom:6px">
            <button id="btnX2" class="btn btn-large btn-xtra2">Xstra Bonus 2 (Rp 10.000)</button>
            <div class="progress-wrap"><div id="progressX2" class="progress-bar" style="background:linear-gradient(90deg,#f472b6,#a78bfa)"></div></div>
            <div class="counter" id="counterX2">0 / 10 hari ini</div>
          </div>

          <div style="margin-top:12px"><div id="statusMsg" class="small"></div></div>
        </div>
      </div>

      <!-- Right: minimal (info hidden from user) -->
      <div>
        <div class="card">
          <div class="title">Profil</div>
          <div style="margin-top:10px" class="small">
            <div><strong>Email:</strong> <span id="infoEmail">—</span></div>
            <div><strong>Status:</strong> <span id="infoBanned">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin panel (hidden unless admin) -->
  <div id="adminPanel">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Admin Panel</div>
        <button id="closeAdmin" class="btn" style="padding:6px 8px">Close</button>
      </div>
      <div style="margin-top:10px">
        <input id="queryUid" placeholder="Cari UID / email" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:#071018;color:#fff">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnFetchUser" class="btn btn-large" style="padding:8px 10px">Fetch</button>
          <button id="btnUnban" class="btn btn-large" style="padding:8px 10px;background:#f97316;color:#021018">Unban</button>
        </div>
        <div id="adminInfo" class="small" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

<script type="module">
/* Final script with fixes:
 - Auth (email/password), auto-login
 - Realtime DB: user document fields initialised
 - Cooldown persisted in DB (lastEarn, lastX1, lastX2)
 - runTransaction used to increment balance
 - Progress bars represent daily usage (earnToday / limits)
 - Reset at 06:00 local time (client scheduled + login check)
 - Anti-tuyul aggressive (devices, ips nodes), auto-ban
 - Banned overlay locks UI
 - Admin panel (manual unban) controlled by ADMIN_EMAILS
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getDatabase, ref, set, get, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpKWInCFVA_4-qyCT4QvW86e1uVf5YtEA",
  authDomain: "nusataskproject-872a1.firebaseapp.com",
  databaseURL: "https://nusataskproject-872a1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nusataskproject-872a1",
  storageBucket: "nusataskproject-872a1.firebasestorage.app",
  messagingSenderId: "669134125045",
  appId: "1:669134125045:web:840b60f2f987aba8fcd2bc",
  measurementId: "G-MX4259KDTG"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// configs
const COOLDOWN = 3 * 60 * 1000;
const EARN_REWARD = 20000;
const XTRA_REWARD = 10000;
const EARN_LIMIT = 20;
const XTRA_LIMIT = 10;

// replace with your admin emails
const ADMIN_EMAILS = ['you@domain.com'];

// UI refs
const $ = id => document.getElementById(id);
const loading = $('loading'), loadingBar = $('loadingBar'), appWrap = $('app');
const bannedOverlay = $('bannedOverlay');
const authModal = $('authModal'), inputEmail = $('inputEmail'), inputPass = $('inputPass'), btnAuth = $('btnAuth');
const btnEarn = $('btnEarn'), btnX1 = $('btnX1'), btnX2 = $('btnX2');
const progressEarn = $('progressEarn'), progressX1 = $('progressX1'), progressX2 = $('progressX2');
const counterEarn = $('counterEarn'), counterX1 = $('counterX1'), counterX2 = $('counterX2');
const statusMsg = $('statusMsg'), emailDisplay = $('emailDisplay'), saldoDisplay = $('saldoDisplay');
const infoEmail = $('infoEmail'), infoBanned = $('infoBanned');

const adminPanel = $('adminPanel'), queryUid = $('queryUid'), btnFetchUser = $('btnFetchUser'), btnUnban = $('btnUnban'), adminInfo = $('adminInfo'), closeAdmin = $('closeAdmin');

// helper format
const fmt = n => 'Rp ' + Number(n||0).toLocaleString('id-ID');

// device id
function getDeviceId(){
  let d = localStorage.getItem('nusa_device_id');
  if(!d){
    d = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'dev-'+Math.random().toString(36).slice(2,12);
    localStorage.setItem('nusa_device_id', d);
  }
  return d;
}
const deviceId = getDeviceId();

// animate loading bar to 100% (3s) then show auth/login
(function animateLoading(){
  let w = 0; const step = 100/50; const iv = setInterval(()=>{
    w += step; loadingBar.style.width = Math.min(100, w) + '%';
    if(w >= 100){ clearInterval(iv); setTimeout(()=>{ loading.style.display='none'; authModal.style.display='flex'; }, 300); }
  }, 60);
})();

// fetch public IP
async function fetchIP(){
  try{
    const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json(); return j.ip;
  }catch(e){ console.warn('ip fail',e); return '0.0.0.0'; }
}

// AUTH: login or register using email+password button in modal
btnAuth.addEventListener('click', async ()=>{
  const email = inputEmail.value.trim(); const pass = inputPass.value.trim();
  if(!email || !pass) return Swal.fire('Isi form','Email & password diperlukan','warning');
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    // success handled by onAuthStateChanged
  }catch(err){
    // register
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      // user created; onAuthStateChanged will handle record creation
    }catch(e){
      Swal.fire('Error', e.message, 'error');
    }
  }
});

// onAuth state -> init or show UI
onAuthStateChanged(auth, async (user)=>{
  if(user){
    authModal.style.display = 'none';
    appWrap.style.display = 'block';
    const uid = user.uid;
    const email = user.email || '—';
    emailDisplay.textContent = email;
    infoEmail.textContent = email;

    // initialize DB user if missing (ensure fields exist)
    const uRef = ref(db, 'users/'+uid);
    const snap = await get(uRef);
    if(!snap.exists()){
      await set(uRef, {
        email,
        balance: 0,
        earnToday: 0, bonus1Today: 0, bonus2Today: 0,
        lastEarn: 0, lastBonus1: 0, lastBonus2: 0,
        lastReset: new Date().toDateString(),
        deviceId: deviceId,
        ip: 'unknown',
        lastIpChangeTime: 0,
        ipHistory: {},
        banned: false
      });
    } else {
      // if deviceId missing, set once
      const data = snap.val();
      if(!data.deviceId) await update(uRef, { deviceId });
    }

    // anti-tuyul checks and register device/ip mappings
    try{ await antiTuyulRegister(uid); } catch(e){
      console.warn('antiTuyul:', e.message);
      // after ban, UI update will show overlay via onValue listener
    }

    // realtime listener for user's node -> update UI & cooldowns
    onValue(ref(db, 'users/'+uid), (s)=>{
      if(!s.exists()) return;
      const d = s.val();
      refreshUI(d);
      if(d.banned) showBannedOverlay();
      else hideBannedOverlay();
    });

    // schedule reset at next 06:00 local
    scheduleReset06(uid);

    // if admin, show admin panel
    if(ADMIN_EMAILS.includes(email.toLowerCase())){
      adminPanel.style.display = 'block';
    } else adminPanel.style.display = 'none';

  } else {
    // not logged in
    appWrap.style.display = 'none';
    authModal.style.display = 'flex';
    adminPanel.style.display = 'none';
  }
});

// Anti-tuyul: map devices and ips, apply ban rules
async function antiTuyulRegister(uid){
  const ip = await fetchIP();
  const now = Date.now();
  const uRef = ref(db, 'users/'+uid);
  const snap = await get(uRef);
  if(!snap.exists()) throw new Error('user-missing');
  const user = snap.val();

  // 1) if user's deviceId exists and differs from current device -> ban user
  if(user.deviceId && user.deviceId !== deviceId){
    await update(uRef, { banned: true });
    throw new Error('device-mismatch');
  }

  // 2) devices/{deviceId} mapping
  const devRef = ref(db, 'devices/'+deviceId);
  const devSnap = await get(devRef);
  if(!devSnap.exists()){
    // bind device => uid
    await set(devRef, { uid, ip, ts: now });
  } else {
    const dv = devSnap.val();
    if(dv.uid && dv.uid !== uid){
      // device used by different uid => ban both sides (aggressive)
      // ban current uid
      await update(uRef, { banned: true });
      // also ban the other account conservatively:
      if(dv.uid) await update(ref(db, 'users/'+dv.uid), { banned: true });
      throw new Error('device-in-use-by-other');
    } else {
      // update device ip+ts
      await update(devRef, { ip, ts: now, uid });
    }
  }

  // 3) ips/{ipKey} mapping to list of deviceIds in 24h
  const ipKey = ip.replace(/\./g,'-');
  const ipRef = ref(db, 'ips/'+ipKey);
  const ipSnap = await get(ipRef);
  let list = ipSnap.exists() ? ipSnap.val().list || [] : [];
  const DAY = 24*60*60*1000;
  list = list.filter(x => now - (x.ts||0) < DAY);

  // if same IP used by other devices -> ban all involved (as requested)
  const otherDevices = list.map(x=>x.deviceId).filter(d=>d && d !== deviceId);
  if(otherDevices.length > 0){
    // ban current user
    await update(uRef, { banned: true });
    // ban the other users mapped to those devices
    for(const od of otherDevices){
      const dvSnap = await get(ref(db, 'devices/'+od));
      if(dvSnap.exists() && dvSnap.val().uid) await update(ref(db, 'users/'+dvSnap.val().uid), { banned: true });
    }
    throw new Error('multiple-devices-same-ip');
  }

  // push this device into ip list
  list.push({ deviceId, uid, ts: now });
  await set(ipRef, { list });

  // 4) update user ip & ipHistory & lastIpChangeTime with grace logic
  let updates = {};
  if(!user.ip || user.ip !== ip){
    const lastChange = user.lastIpChangeTime || 0;
    const SIX_HOURS = 6*60*60*1000;
    if(lastChange && (now - lastChange) < SIX_HOURS){
      // frequent IP changes -> ban
      await update(uRef, { banned: true });
      throw new Error('frequent-ip-change');
    }
    updates.ip = ip;
    updates.lastIpChangeTime = now;
    const hist = user.ipHistory || {};
    hist[now] = { ip, deviceId };
    updates.ipHistory = hist;
  }
  if(Object.keys(updates).length) await update(uRef, updates);
}

// Refresh UI: saldo, counters, progress, cooldown states
function refreshUI(d){
  saldoDisplay.textContent = fmt(d.balance || 0);
  emailDisplay.textContent = d.email || '—';
  infoEmail.textContent = d.email || '—';
  infoBanned.textContent = d.banned ? 'BANNED' : 'ACTIVE';

  const e = d.earnToday || 0, x1 = d.bonus1Today || 0, x2 = d.bonus2Today || 0;
  counterEarn.textContent = `${e} / ${EARN_LIMIT} hari ini`;
  counterX1.textContent = `${x1} / ${XTRA_LIMIT} hari ini`;
  counterX2.textContent = `${x2} / ${XTRA_LIMIT} hari ini`;

  progressEarn.style.width = Math.min(100, Math.round((e / EARN_LIMIT) * 100)) + '%';
  progressX1.style.width = Math.min(100, Math.round((x1 / XTRA_LIMIT) * 100)) + '%';
  progressX2.style.width = Math.min(100, Math.round((x2 / XTRA_LIMIT) * 100)) + '%';

  // cooldown UI from persisted timestamps
  const now = Date.now();
  if(d.lastEarn && (now - d.lastEarn) < COOLDOWN) startCooldownBtn(btnEarn, d.lastEarn, COOLDOWN, 'Menghasilkan (Rp 20.000)');
  else resetBtn(btnEarn, 'Menghasilkan (Rp 20.000)');
  if(d.lastBonus1 && (now - d.lastBonus1) < COOLDOWN) startCooldownBtn(btnX1, d.lastBonus1, COOLDOWN, 'Xstra Bonus 1 (Rp 10.000)');
  else resetBtn(btnX1, 'Xstra Bonus 1 (Rp 10.000)');
  if(d.lastBonus2 && (now - d.lastBonus2) < COOLDOWN) startCooldownBtn(btnX2, d.lastBonus2, COOLDOWN, 'Xstra Bonus 2 (Rp 10.000)');
  else resetBtn(btnX2, 'Xstra Bonus 2 (Rp 10.000)');
}

// disable all UI and show banned overlay
function showBannedOverlay(){
  bannedOverlay.style.display = 'flex';
  // disable buttons
  btnEarn.classList.add('disabled'); btnX1.classList.add('disabled'); btnX2.classList.add('disabled');
}
// hide overlay
function hideBannedOverlay(){ bannedOverlay.style.display = 'none'; }

// cooldown UI helpers
function startCooldownBtn(btn, lastTs, duration, originalText){
  const remaining = Math.max(0, duration - (Date.now() - lastTs));
  if(remaining <= 0){ resetBtn(btn, originalText); return; }
  btn.classList.add('disabled');
  let end = Date.now() + remaining;
  btn.innerText = formatRem(remaining);
  const iv = setInterval(()=>{
    const rem = end - Date.now();
    if(rem <= 0){ clearInterval(iv); resetBtn(btn, originalText); }
    else btn.innerText = formatRem(rem);
  }, 1000);
}
function resetBtn(btn, text){ btn.classList.remove('disabled'); btn.innerText = text; }
function formatRem(ms){ const mm = Math.floor(ms/60000); const ss = Math.floor((ms%60000)/1000); return `Cooldown (${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')})`; }

// schedule daily reset at next 06:00 local time
function scheduleReset06(uid){
  const now = new Date();
  const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0, 0, 0);
  if(now >= target) target.setDate(target.getDate() + 1);
  const ms = target.getTime() - now.getTime();
  setTimeout(async ()=>{
    try{
      await update(ref(db, 'users/'+uid), { earnToday: 0, bonus1Today: 0, bonus2Today: 0, lastReset: new Date().toDateString() });
    }catch(e){ console.warn('reset error', e); }
    scheduleReset06(uid);
  }, ms + 2000);
}

// claim reward (atomic balance update using runTransaction)
async function claim(uid, type){
  const uRef = ref(db, 'users/'+uid);
  const snap = await get(uRef);
  if(!snap.exists()) return Swal.fire('Error','User data not found','error');
  const d = snap.val();
  if(d.banned) return Swal.fire('Akun dibanned','Kontak admin','error');

  // ensure daily reset if needed
  const today = new Date().toDateString();
  if(d.lastReset !== today){
    d.earnToday = 0; d.bonus1Today = 0; d.bonus2Today = 0; d.lastReset = today;
  }
  const now = Date.now();

  // earn
  if(type === 'earn'){
    if((d.earnToday||0) >= EARN_LIMIT) return Swal.fire('Limit','Sudah capai limit harian','warning');
    if(d.lastEarn && (now - d.lastEarn) < COOLDOWN) return Swal.fire('Cooldown','Tunggu beberapa saat','info');

    // increment balance atomically
    await runTransaction(ref(db, 'users/'+uid+'/balance'), cur => (cur||0)+EARN_REWARD);
    await update(uRef, { earnToday: (d.earnToday||0)+1, lastEarn: now });
    startCooldownBtn(btnEarn, now, COOLDOWN, 'Menghasilkan (Rp 20.000)');
    Swal.fire('Berhasil','Rp 20.000 telah dikreditkan','success');
    return;
  }

  // bonus1
  if(type === 'x1'){
    if((d.bonus1Today||0) >= XTRA_LIMIT) return Swal.fire('Limit','Bonus1 sudah capai hari ini','warning');
    if(d.lastBonus1 && (now - d.lastBonus1) < COOLDOWN) return Swal.fire('Cooldown','Tunggu beberapa saat','info');

    await runTransaction(ref(db, 'users/'+uid+'/balance'), cur => (cur||0)+XTRA_REWARD);
    await update(uRef, { bonus1Today: (d.bonus1Today||0)+1, lastBonus1: now });
    startCooldownBtn(btnX1, now, COOLDOWN, 'Xstra Bonus 1 (Rp 10.000)');
    Swal.fire('Berhasil','Rp 10.000 telah dikreditkan','success');
    return;
  }

  // bonus2
  if(type === 'x2'){
    if((d.bonus2Today||0) >= XTRA_LIMIT) return Swal.fire('Limit','Bonus2 sudah capai hari ini','warning');
    if(d.lastBonus2 && (now - d.lastBonus2) < COOLDOWN) return Swal.fire('Cooldown','Tunggu beberapa saat','info');

    await runTransaction(ref(db, 'users/'+uid+'/balance'), cur => (cur||0)+XTRA_REWARD);
    await update(uRef, { bonus2Today: (d.bonus2Today||0)+1, lastBonus2: now });
    startCooldownBtn(btnX2, now, COOLDOWN, 'Xstra Bonus 2 (Rp 10.000)');
    Swal.fire('Berhasil','Rp 10.000 telah dikreditkan','success');
    return;
  }
}

// button click handlers
btnEarn.addEventListener('click', async ()=>{
  const u = auth.currentUser; if(!u) return Swal.fire('Login','Silakan login','info');
  await claim(u.uid, 'earn');
});
btnX1.addEventListener('click', async ()=>{ const u = auth.currentUser; if(!u) return Swal.fire('Login','Silakan login','info'); await claim(u.uid, 'x1'); });
btnX2.addEventListener('click', async ()=>{ const u = auth.currentUser; if(!u) return Swal.fire('Login','Silakan login','info'); await claim(u.uid, 'x2'); });

// Admin panel logic
closeAdmin.addEventListener('click', ()=> adminPanel.style.display = 'none');
btnFetchUser.addEventListener('click', async ()=>{
  const q = queryUid.value.trim();
  if(!q) return adminInfo.innerText = 'Masukkan UID atau email.';
  // try find by uid first
  let snap = await get(ref(db, 'users/'+q));
  if(!snap.exists()){
    // search by email (inefficient - for demo only)
    const all = await get(ref(db, 'users'));
    if(all.exists()){
      const users = all.val();
      let foundUid = null, foundData = null;
      for(const k of Object.keys(users)){
        if(users[k].email && users[k].email.toLowerCase() === q.toLowerCase()){
          foundUid = k; foundData = users[k]; break;
        }
      }
      if(!foundUid) return adminInfo.innerText = 'User tidak ditemukan.';
      snap = { exists: ()=>true, val: ()=>foundData, key: foundUid };
      adminInfo.innerText = `UID: ${foundUid}\nEmail: ${foundData.email}\nBanned: ${foundData.banned}`;
      adminInfo.dataset.uid = foundUid;
    } else return adminInfo.innerText = 'User tidak ditemukan.';
  } else {
    adminInfo.innerText = `UID: ${q}\nEmail: ${snap.val().email}\nBanned: ${snap.val().banned}`;
    adminInfo.dataset.uid = q;
  }
});
btnUnban.addEventListener('click', async ()=>{
  const uid = adminInfo.dataset.uid;
  if(!uid) return adminInfo.innerText = 'Tidak ada user terpilih.';
  await update(ref(db, 'users/'+uid), { banned: false });
  adminInfo.innerText = `UID: ${uid}\nUNBANNED`;
  Swal.fire('Sukses','User telah di-unban','success');
});

</script>
</body>
</html>