<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NUSATASK â€” Final Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  :root{
    --bg1:#07070b;--bg2:#0f1724;
    --muted:#9aa7b6;
    --grad1:#8b5cf6;--grad2:#06b6d4;--grad3:#10b981;
    --gold:#FFD700;
  }
  html,body{height:100%;margin:0;font-family:Poppins,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef6}
  /* Splash */
  #splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(180deg,#06070a,#081425);z-index:9999}
  #splash .logo{font-family:Orbitron,system-ui;font-size:48px;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 8px 30px rgba(139,92,246,0.12));animation:logoPulse 1.8s ease-in-out infinite}
  @keyframes logoPulse{0%{transform:scale(.98)}50%{transform:scale(1.03)}100%{transform:scale(.98)}}
  .small-muted{color:var(--muted);font-size:13px;margin-top:10px}

  /* Layout */
  .wrap{max-width:920px;margin:28px auto;padding:20px;}
  header{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;margin-top:28px}
  .brand{font-family:Orbitron,system-ui;font-weight:700;font-size:28px;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .tag{color:var(--muted);font-size:13px}

  /* card */
  .card{width:92%;max-width:420px;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);border-radius:16px;padding:20px;margin:22px auto;backdrop-filter:blur(8px);box-shadow:0 12px 40px rgba(2,6,23,0.6)}
  .toprow{display:flex;justify-content:space-between;align-items:center}
  .saldo{font-weight:700;color:var(--gold);text-shadow:0 4px 18px rgba(255,215,0,0.08)}

  /* buttons */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(90deg,var(--grad1),var(--grad2));border:none;color:#fff;padding:12px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .12s,box-shadow .12s}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  .btn.disabled{opacity:.45;pointer-events:none}

  /* progress */
  .progress-wrap{height:12px;background:rgba(255,255,255,0.04);border-radius:12px;overflow:hidden;margin-top:10px}
  .progress{height:100%;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));background-size:200% 100%;animation:moveGrad 2.2s linear infinite}
  @keyframes moveGrad{0%{background-position:0 0}100%{background-position:200% 0}}

  /* modal login/register */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9998}
  .modal .box{width:min(420px,92%);background:linear-gradient(180deg,#0b1220,#0f1726);padding:20px;border-radius:14px;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
  .modal h3{font-family:Orbitron,system-ui;margin:0 0 8px 0}
  .input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;margin-top:10px}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}

  /* toast */
  #toast{position:fixed;left:50%;top:28px;transform:translateX(-50%);min-width:220px;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#fff;font-weight:700;display:none;z-index:99999;box-shadow:0 8px 30px rgba(2,6,23,0.6)}

  /* warning popup after register */
  #warning{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.85));z-index:99997}
  #warning .box{background:#071224;padding:20px;border-radius:12px;color:#e6eef6;max-width:420px;text-align:center}
  #warning .danger{color:#ff7b7b;margin-top:10px}

  /* banned overlay */
  #banned{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:99999;color:#ff7b7b;text-align:center;padding:20px}

  /* responsiveness */
  @media(max-width:520px){ .brand{font-size:22px} .card{padding:16px} }

</style>
</head>
<body>

<!-- splash -->
<div id="splash">
  <div class="logo">NT</div>
  <div class="small-muted">Memuat NusaTask â€” Premium</div>
</div>

<div class="wrap">
  <header>
    <div class="brand">NusaTask</div>
    <div class="tag">Premium â€¢ Secure â€¢ Dark UI</div>
  </header>

  <div class="card">
    <div class="toprow">
      <div>
        <div style="font-weight:800;font-size:18px">Dashboard</div>
        <div class="muted">Tekan tombol untuk mengumpulkan.</div>
      </div>
      <div class="saldo">Saldo: <span id="saldo">0</span></div>
    </div>

    <div style="margin-top:18px">
      <div style="margin-bottom:14px">
        <button id="earnBtn" class="btn">ðŸŽ¯ Earn (+1)</button>
        <div class="progress-wrap"><div id="earnBar" class="progress"></div></div>
        <div class="muted" style="margin-top:8px">Terpakai hari ini: <span id="earnUsed">0</span>/<span id="earnMax">25</span></div>
      </div>

      <div>
        <button id="bonusBtn" class="btn">ðŸ’Ž Bonus (+30)</button>
        <div class="progress-wrap"><div id="bonusBar" class="progress"></div></div>
        <div class="muted" style="margin-top:8px">Terpakai hari ini: <span id="bonusUsed">0</span>/<span id="bonusMax">25</span></div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="muted">Jika dibanned hubungi admin: <a href="https://t.me/nusataskproject" style="color:var(--grad2)">t.me/nusataskproject</a></div>
  </div>
</div>

<!-- Modal: Login/Register -->
<div id="authModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 id="authTitle">Masuk / Daftar</h3>
    <input id="mEmail" class="input" type="email" placeholder="Email">
    <input id="mPass" class="input" type="password" placeholder="Password (min 6)">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="loginBtn" class="btn" style="flex:1">Login</button>
      <button id="registerBtn" class="btn ghost" style="flex:1">Register</button>
    </div>
    <div id="authNote" class="muted">Dengan mendaftar, segala bentuk hack/nuyul akan dibanned otomatis.</div>
  </div>
</div>

<!-- Warning after register -->
<div id="warning">
  <div class="box">
    <div style="font-weight:800;font-size:18px">Peringatan Penting</div>
    <div class="muted" style="margin-top:8px">Segala bentuk hack / multi-akun dari 1 device atau 1 IP akan menyebabkan banned otomatis.</div>
    <div class="danger">Lanjutkan hanya jika Anda setuju.</div>
    <div style="margin-top:12px"><button id="continueBtn" class="btn disabled">LANJUTKAN (5s)</button></div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Banned overlay -->
<div id="banned"><div><div style="font-weight:800;font-size:20px">ðŸš« AKUN DIBANNED</div><div class="muted" style="margin-top:8px">Hubungi admin: <a href="https://t.me/nusataskproject" style="color:var(--grad2)">t.me/nusataskproject</a></div></div></div>

<script>
/* ================= CONFIG ================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAUcac_uXdofDbqPwltgb4m7qIPiQhJi0s",
  authDomain: "nusataskproject.firebaseapp.com",
  databaseURL: "https://nusataskproject-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nusataskproject",
  storageBucket: "nusataskproject.firebasestorage.app",
  messagingSenderId: "409602188456",
  appId: "1:409602188456:web:6302d3030b763324e28e9d",
  measurementId: "G-9389QL1WRE"
};
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.database();

/* ================= CONSTANTS ================= */
const COOLDOWN = 3 * 60 * 1000; // 3 minutes
const EARN_MAX = 25;
const BONUS_MAX = 25;

/* ================= UI refs ================= */
const splash = document.getElementById('splash');
const authModal = document.getElementById('authModal');
const mEmail = document.getElementById('mEmail');
const mPass = document.getElementById('mPass');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const toastEl = document.getElementById('toast');
const warning = document.getElementById('warning');
const continueBtn = document.getElementById('continueBtn');
const bannedEl = document.getElementById('banned');

const saldoEl = document.getElementById('saldo');
const earnBtn = document.getElementById('earnBtn');
const bonusBtn = document.getElementById('bonusBtn');
const earnBar = document.getElementById('earnBar');
const bonusBar = document.getElementById('bonusBar');
const earnUsedEl = document.getElementById('earnUsed');
const bonusUsedEl = document.getElementById('bonusUsed');
const earnMaxEl = document.getElementById('earnMax');
const bonusMaxEl = document.getElementById('bonusMax');

earnMaxEl.innerText = EARN_MAX;
bonusMaxEl.innerText = BONUS_MAX;

/* ================= helpers ================= */
function showToast(text, time=3000){
  toastEl.innerText = text; toastEl.style.display='block';
  setTimeout(()=>toastEl.style.display='none', time);
}
function getDeviceId(){
  let d = localStorage.getItem('nusatask_device');
  if(!d){ d = 'dev-'+Math.random().toString(36).slice(2,12); localStorage.setItem('nusatask_device', d); }
  return d;
}
const deviceId = getDeviceId();

async function fetchIP(){
  try{
    const res = await fetch('https://api.ipify.org?format=json'); const j=await res.json(); return j.ip||'unknown';
  }catch(e){ return 'unknown'; }
}

/* server time helper (caches offset) */
let _offset = null;
async function getServerTime(){
  if(_offset === null){
    const snap = await db.ref('.info/serverTimeOffset').once('value');
    _offset = snap.val() || 0;
  }
  return Date.now() + _offset;
}

/* ================= AUTH UI ================= */
function openAuthModal(){ authModal.style.display='flex'; mEmail.focus(); }
function closeAuthModal(){ authModal.style.display='none'; }

/* Login/Register handlers */
loginBtn.addEventListener('click', async ()=>{
  const email = mEmail.value.trim(); const pass = mPass.value;
  if(!email || pass.length < 6){ showToast('Email & password (min 6)'); return; }
  showToast('Logging inâ€¦', 2000);
  try{ await auth.signInWithEmailAndPassword(email, pass); closeAuthModal(); }
  catch(e){ showToast('Login failed: '+e.message,4000); }
});
registerBtn.addEventListener('click', async ()=>{
  const email = mEmail.value.trim(); const pass = mPass.value;
  if(!email || pass.length < 6){ showToast('Email & password (min 6)'); return; }
  showToast('Mendaftarâ€¦',2000);
  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    // flag that user just registered so we show warning flow
    localStorage.setItem('nusatask_justRegistered','1');
    closeAuthModal();
  }catch(e){ showToast('Register failed: '+e.message,4000); }
});

/* if not authed, open auth modal */
auth.onAuthStateChanged(async user => {
  if(!user){
    // show auth modal
    openAuthModal();
    return;
  }

  // user signed in
  closeAuthModal();
  const uid = user.uid;
  const userRef = db.ref('users/'+uid);

  // check security and initialize
  const ok = await performSecurityChecks(uid);
  if(!ok){
    showBannedOverlay();
    return;
  }

  // create default data if not exist
  const snap = await userRef.once('value');
  const serverNow = await getServerTime();
  if(!snap.exists()){
    await userRef.set({
      email: user.email || null,
      balance: 0,
      banned: false,
      deviceId: deviceId,
      ip: await fetchIP(),
      earnUsedToday: 0,
      bonusUsedToday: 0,
      nextEarnAt: 0,
      nextBonusAt: 0,
      lastResetAt: serverNow,
      createdAt: serverNow
    });
  } else {
    // ensure device binding exists (if device slot empty bind it)
    const data = snap.val();
    if(!data.deviceId){
      await db.ref('devices/'+deviceId).set({uid:uid,createdAt:serverNow});
      await userRef.update({deviceId});
    } else {
      // ensure devices mapping present
      await db.ref('devices/'+deviceId).set({uid:uid});
    }
  }

  // if just registered show warning popup (5s) then continue
  if(localStorage.getItem('nusatask_justRegistered')==='1'){
    localStorage.removeItem('nusatask_justRegistered');
    await showWarningThenContinue();
  }

  // start listening user changes
  startUserListener(uid);
  // hide splash
  document.getElementById('splash').style.display='none';
});

/* ================= Security logic ================= */
async function performSecurityChecks(uid){
  const ip = await fetchIP();
  const userRef = db.ref('users/'+uid);

  // 1) device binding check
  const devSnap = await db.ref('devices/'+deviceId).once('value');
  if(devSnap.exists() && devSnap.val().uid !== uid){
    // device already bound to another uid -> ban this uid
    await userRef.set({banned:true});
    return false;
  }

  // 2) ip check
  const ipRoot = db.ref('iplog/'+ip);
  const ipSnap = await ipRoot.once('value');
  if(ipSnap.exists()){
    const entries = ipSnap.val();
    const keys = Object.keys(entries||{});
    // if ip already used by other uid(s)
    for(const otherUid of keys){
      if(otherUid === uid) continue;
      // allow if that otherUid maps to same deviceId (user switched IP) -> we need to check devices
      const otherDeviceSnap = await db.ref('users/'+otherUid+'/deviceId').once('value');
      const otherDevice = otherDeviceSnap.exists() ? otherDeviceSnap.val() : null;
      if(otherDevice === deviceId){
        // same device, different email on same device -> this violates one-email-per-device policy -> ban (require: one email per device)
        // as per latest strict rules: one device = one account => ban
        await userRef.set({banned:true}); return false;
      } else {
        // different device uses same IP -> ban
        await userRef.set({banned:true}); return false;
      }
    }
  }

  // 3) ensure device mapping stored
  await db.ref('devices/'+deviceId).set({uid:uid,createdAt:Date.now()});
  // 4) log ip usage
  await ipRoot.child(uid).set({ts: Date.now()});
  // pass
  return true;
}

/* ================= user listener ================= */
let currentUserRef = null;
async function startUserListener(uid){
  if(currentUserRef) currentUserRef.off();
  currentUserRef = db.ref('users/'+uid);
  currentUserRef.on('value', async snap=>{
    const data = snap.val(); if(!data) return;
    if(data.banned){ showBannedOverlay(); return; }

    // reset if needed based on server time (server reset logic)
    const serverNow = await getServerTime();
    // compute server reset boundary 06:00 (server)
    const resetBoundary = (()=>{ const d = new Date(serverNow); d.setHours(6,0,0,0); if(serverNow < d.getTime()) d.setDate(d.getDate()-1); return d.getTime(); })();
    if(!data.lastResetAt || data.lastResetAt < resetBoundary){
      await currentUserRef.update({earnUsedToday:0,bonusUsedToday:0,lastResetAt:serverNow});
      data.earnUsedToday = 0; data.bonusUsedToday = 0;
    }

    // update UI
    saldoEl.innerText = (data.balance||0);
    earnUsedEl.innerText = data.earnUsedToday||0;
    bonusUsedEl.innerText = data.bonusUsedToday||0;
    earnBar.style.width = ((data.earnUsedToday||0)/EARN_MAX*100)+'%';
    bonusBar.style.width = ((data.bonusUsedToday||0)/BONUS_MAX*100)+'%';

    // cooldown buttons based on server time and next* fields
    const serverNow2 = await getServerTime();
    const nextE = data.nextEarnAt||0, nextB = data.nextBonusAt||0;
    if(serverNow2 < nextE){ earnBtn.classList.add('disabled'); } else { earnBtn.classList.remove('disabled'); }
    if(serverNow2 < nextB){ bonusBtn.classList.add('disabled'); } else { bonusBtn.classList.remove('disabled'); }
  });
}

/* ================= Warning modal after register ================= */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function showWarningThenContinue(){
  warning.style.display='flex';
  continueBtn.disabled = true; continueBtn.classList.add('disabled');
  let t=5;
  const origTxt = continueBtn.innerText;
  while(t>0){
    continueBtn.innerText = `LANJUTKAN (${t}s)`; await sleep(1000); t--;
  }
  continueBtn.innerText = 'LANJUTKAN'; continueBtn.disabled=false; continueBtn.classList.remove('disabled');
  await new Promise(resolve => { continueBtn.onclick = ()=>{ warning.style.display='none'; continueBtn.onclick=null; resolve(); }; });
}

/* ================= Earn / Bonus (transactions using server time) ================= */
earnBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user) return showToast('Belum login');
  const serverNow = await getServerTime();
  const ref = db.ref('users/'+user.uid);
  ref.transaction(data=>{
    if(!data) return;
    // daily reset done in listener, but double-check
    const lastReset = data.lastResetAt || 0;
    const resetBoundary = (()=>{ const d=new Date(serverNow); d.setHours(6,0,0,0); if(serverNow<d.getTime()) d.setDate(d.getDate()-1); return d.getTime(); })();
    if(!lastReset || lastReset < resetBoundary){
      data.earnUsedToday = 0; data.bonusUsedToday = 0; data.lastResetAt = serverNow;
    }
    if((data.earnUsedToday||0) >= EARN_MAX) { showToast('Limit harian tercapai'); return; }
    if(serverNow < (data.nextEarnAt||0)) { showToast('Masih cooldown'); return; }
    data.balance = (data.balance||0) + 1;
    data.earnUsedToday = (data.earnUsedToday||0) + 1;
    data.nextEarnAt = serverNow + COOLDOWN;
    data.lastActionAt = serverNow;
    return data;
  }, function(err, committed, snapshot){
    if(err){ showToast('Terjadi kesalahan'); console.error(err); }
    else if(!committed){ /* no-op */ }
    else { // success
      showToast('Berhasil +1'); // UI updates via listener
      // small visual feedback
      earnBar.style.transition='width .5s ease'; earnBar.style.width = Math.min(100, ((parseInt(earnUsedEl.innerText||'0')+1)/EARN_MAX*100)) + '%';
    }
  });
});

bonusBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user) return showToast('Belum login');
  const serverNow = await getServerTime();
  const ref = db.ref('users/'+user.uid);
  ref.transaction(data=>{
    if(!data) return;
    const lastReset = data.lastResetAt || 0;
    const resetBoundary = (()=>{ const d=new Date(serverNow); d.setHours(6,0,0,0); if(serverNow<d.getTime()) d.setDate(d.getDate()-1); return d.getTime(); })();
    if(!lastReset || lastReset < resetBoundary){
      data.earnUsedToday = 0; data.bonusUsedToday = 0; data.lastResetAt = serverNow;
    }
    if((data.bonusUsedToday||0) >= BONUS_MAX) { showToast('Limit bonus tercapai'); return; }
    if(serverNow < (data.nextBonusAt||0)) { showToast('Bonus masih cooldown'); return; }
    data.balance = (data.balance||0) + 30;
    data.bonusUsedToday = (data.bonusUsedToday||0) + 1;
    data.nextBonusAt = serverNow + COOLDOWN;
    data.lastActionAt = serverNow;
    return data;
  }, function(err, committed, snapshot){
    if(err){ showToast('Terjadi kesalahan'); console.error(err); }
    else if(!committed){ }
    else { showToast('+30 berhasil'); bonusBar.style.transition='width .5s ease'; bonusBar.style.width = Math.min(100, ((parseInt(bonusUsedEl.innerText||'0')+1)/BONUS_MAX*100)) + '%'; }
  });
});

/* banned overlay */
function showBannedOverlay(){ bannedEl.style.display='flex'; showToast('Akun dibanned',4000); }

/* show auth modal on first load (if not authed) */
window.addEventListener('load', ()=>{
  // show splash minimally 600ms
  setTimeout(()=>{ document.getElementById('splash').style.display='none'; }, 600);
  // if no user -> open auth modal (auth state will handle)
  setTimeout(()=>{ if(!auth.currentUser) authModal.style.display='flex'; }, 700);
});
</script>
</body>
</html>